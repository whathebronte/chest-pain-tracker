<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Chest Pain Tracker</title>
  <style>
    :root{
      --bg0:#05070b;
      --bg1:#0b0f18;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.45);
      --accent:#7aa2ff;
      --accent2:#3ddc97;
      --danger:#ff5d5d;
      --warn:#ffd166;
      --shadow: 0 16px 48px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 14px;
      --pad: 16px;
      --font: -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(122,162,255,.22), transparent 55%),
                  radial-gradient(1200px 800px at 80% 0%, rgba(61,220,151,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg0));
      color:var(--text);
      font-family:var(--font);
    }

    /* Slightly larger, elder-friendly baseline */
    body{ font-size: 17px; line-height: 1.25; }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px 90px;
      box-sizing:border-box;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 10px 2px 16px;
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(11,15,24,.92), rgba(11,15,24,.55), transparent);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:0;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(120% 120% at 30% 20%, rgba(122,162,255,1), rgba(61,220,151,.8));
      box-shadow: 0 10px 28px rgba(0,0,0,.45);
      flex: 0 0 auto;
    }
    .brand h1{
      font-size: 22px;
      margin:0;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .brand .sub{
      margin-top:2px;
      color: var(--muted);
      font-size: 14px;
    }

    .sync{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      flex: 0 0 auto;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent2);
      box-shadow: 0 0 0 6px rgba(61,220,151,.12);
    }
    .sync .label{
      font-weight: 700;
      letter-spacing:.2px;
      font-size: 15px;
      white-space: nowrap;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
      margin: 12px 0;
    }

    .card h2{
      margin: 0 0 10px;
      font-size: 20px;
    }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 700;
      letter-spacing:.15px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.70));
      border-color: rgba(122,162,255,.55);
      color: rgba(0,0,0,.92);
    }
    .btn.danger{
      background: rgba(255,93,93,.12);
      border-color: rgba(255,93,93,.35);
      color: rgba(255,255,255,.92);
    }
    .btn.small{
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 12px;
    }
    .btn.full{ width:100%; padding: 16px 16px; font-size: 18px; border-radius: 16px; }

    .muted{ color: var(--muted); }
    .tiny{ font-size: 13px; color: var(--muted2); }

    .tabs{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, transparent, rgba(7,10,15,.7), rgba(7,10,15,.95));
      backdrop-filter: blur(10px);
      z-index: 50;
    }
    .tabbar{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background: rgba(0,0,0,.25);
      border: 1px solid var(--stroke);
      border-radius: 18px;
      padding: 8px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 12px 10px;
      border-radius: 14px;
      font-weight: 800;
      border: 1px solid transparent;
      color: rgba(255,255,255,.85);
      background: transparent;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.70));
      color: rgba(0,0,0,.92);
      border-color: rgba(122,162,255,.55);
    }

    /* Chips */
    .chipset{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      padding: 12px 14px;
      border-radius: 999px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .chip.on{
      background: rgba(61,220,151,.16);
      border-color: rgba(61,220,151,.45);
      box-shadow: 0 0 0 6px rgba(61,220,151,.08);
    }

    /* Inputs */
    .field{ margin: 14px 0; }
    label{ display:block; font-weight: 800; margin-bottom: 8px; color: rgba(255,255,255,.88); }
    input[type="text"], input[type="number"], textarea, select{
      width: 100%;
      box-sizing: border-box;
      background: rgba(0,0,0,.25);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 12px 12px;
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    .divider{ height:1px; background: rgba(255,255,255,.10); margin: 14px 0; }

    /* History list */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .logcard{
      background: rgba(0,0,0,.22);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 14px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .logcard:active{ transform: translateY(1px); }

    .loghead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .logwhen{
      font-weight: 900;
      font-size: 18px;
      letter-spacing:.2px;
      white-space: nowrap; /* prevents AM/PM orphan */
    }
    .logmeta{
      margin-top: 4px;
      color: var(--muted);
      font-size: 14px;
      font-weight: 700;
      letter-spacing:.15px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .logright{
      text-align:right;
      flex: 0 0 auto;
      min-width: 92px;
    }
    .sev{
      font-weight: 900;
      font-size: 18px;
      white-space: nowrap;
    }
    .dur{
      color: var(--muted);
      font-size: 14px;
      font-weight: 800;
      margin-top: 2px;
      white-space: nowrap;
    }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index: 60;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
    }
    .modal.on{ display:flex; }
    .sheet{
      width: min(980px, 100%);
      max-height: 92vh;
      overflow:auto;
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(20,26,40,.96), rgba(10,14,22,.96));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 24px 90px rgba(0,0,0,.75);
      padding: 14px;
    }
    .sheet h3{ margin: 8px 2px 12px; font-size: 20px; }
    .sheet .actions{
      display:flex;
      gap:10px;
      position: sticky;
      bottom: 0;
      padding: 12px 0 0;
      background: linear-gradient(180deg, transparent, rgba(10,14,22,.92) 25%, rgba(10,14,22,.98));
    }
    .sheet .actions .btn{ flex:1; }

    /* Severity slider thicker */
    input[type="range"]{
      width:100%;
      height: 18px;
      background: transparent;
      margin: 10px 0 4px;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.18);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      appearance:none;
      width: 28px; height: 28px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(122,162,255,.98), rgba(122,162,255,.65));
      border: 1px solid rgba(255,255,255,.22);
      margin-top: -9px;
      box-shadow: 0 10px 26px rgba(0,0,0,.55);
    }

    /* Pain type guide text hierarchy */
    .guideTitle{ font-weight: 900; margin: 8px 0 6px; }
    .guideText{ font-size: 14px; color: var(--muted); }

    @media (min-width: 740px){
      body{ font-size: 18px; }
      .brand h1{ font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div style="min-width:0">
        <h1>Chest Pain Tracker</h1>
        <div class="sub">Log episodes · Share reports</div>
      </div>
    </div>
    <div class="sync" id="syncPill" aria-live="polite">
      <div class="dot" id="syncDot"></div>
      <div class="label" id="syncLabel">Starting…</div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME -->
    <section id="viewHome" class="card">
      <h2>Home</h2>
      <button class="btn primary full" id="btnLogNow">Log Chest Pain</button>

      <div class="divider"></div>

      <h2 style="margin-top:0">At a glance</h2>
      <div class="card" style="box-shadow:none;margin:10px 0;background:rgba(0,0,0,.18)">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-size:34px;font-weight:1000" id="glance7">0</div>
            <div class="muted" style="font-weight:800">Episodes (last 7 days)</div>
          </div>
        </div>
      </div>

      <div class="card" style="box-shadow:none;margin:10px 0;background:rgba(0,0,0,.18)">
        <div style="font-size:34px;font-weight:1000" id="glance30">0</div>
        <div class="muted" style="font-weight:800">Episodes (last 30 days)</div>
      </div>

      <div class="card" style="box-shadow:none;margin:10px 0;background:rgba(0,0,0,.18)">
        <div style="font-size:28px;font-weight:1000" id="glanceLastSev">—</div>
        <div class="muted" style="font-weight:800">Last severity</div>
      </div>

      <div class="card" style="box-shadow:none;margin:10px 0;background:rgba(0,0,0,.18)">
        <div style="font-size:18px;font-weight:1000" id="glanceCommonActivity">—</div>
        <div class="muted" style="font-weight:800">Most common onset activity (30 days)</div>
      </div>

      <div class="divider"></div>

      <!-- Unique link block at bottom, compact -->
      <div class="card" style="box-shadow:none;margin:10px 0;background:rgba(0,0,0,.18)">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div style="min-width:0">
            <div style="font-weight:1000;font-size:18px">Your unique link</div>
            <div class="tiny">ID: <span id="uidShort">—</span></div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn small primary" id="btnCopyLink">Copy link</button>
          <button class="btn small" id="btnLoadExisting">Load existing</button>
          <button class="btn small" id="btnShowLink">Show link</button>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="viewHistory" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h2 style="margin:0 0 8px">History</h2>
          <div class="muted" style="font-weight:700">Most recent first.</div>
        </div>
        <div class="row" style="gap:8px">
          <select id="histRange" class="btn" style="padding:10px 12px;border-radius:14px">
            <option value="7" selected>Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
            <option value="all">All time</option>
          </select>
          <select id="histSev" class="btn" style="padding:10px 12px;border-radius:14px">
            <option value="all" selected>All severities</option>
            <option value="mild">Mild (1–3)</option>
            <option value="mod">Moderate (4–6)</option>
            <option value="sev">Severe (7–10)</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      <div id="histList" class="list"></div>
      <div id="histEmpty" class="muted" style="display:none;font-weight:700;padding:10px 2px">No logs in this range.</div>
    </section>

    <!-- EXPORT -->
    <section id="viewExport" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h2 style="margin:0 0 8px">Export</h2>
        </div>
        <div class="row" style="gap:8px">
          <select id="expRange" class="btn" style="padding:10px 12px;border-radius:14px">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
            <option value="all">All time</option>
          </select>
          <button class="btn" id="btnRefreshExport">Refresh</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="card" style="box-shadow:none;margin:10px 0;background:rgba(0,0,0,.18)">
        <div style="font-weight:1000;font-size:18px;margin-bottom:10px">Clinician summary (Print to PDF)</div>
        <div class="row">
          <button class="btn primary" id="btnPrint">Print / Save PDF</button>
          <button class="btn" id="btnCSV">Download CSV</button>
        </div>
      </div>

      <div class="card" style="box-shadow:none;margin:10px 0;background:rgba(0,0,0,.18)">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:1000;font-size:18px">Share a read-only report link</div>
          <button class="btn" id="btnCreateShare">Create / Replace share link</button>
        </div>
        <div class="tiny" style="margin-top:6px">One active link only. No expiry. Revocable anytime.</div>
        <div class="row" style="margin-top:10px">
          <button class="btn small" id="btnCopyShare" disabled>Copy share link</button>
          <button class="btn small danger" id="btnRevokeShare" disabled>Revoke</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- spacing fix: report title needs breathing room -->
      <div style="margin-top:18px">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div style="font-weight:1000;font-size:20px">Chest pain report</div>
            <div class="tiny">Generated: <span id="reportGen">—</span></div>
          </div>
        </div>
      </div>

      <div class="card" style="box-shadow:none;margin:12px 0;background:rgba(0,0,0,.18)">
        <div style="font-weight:1000;font-size:18px;margin-bottom:8px">Summary</div>
        <div class="muted" style="font-weight:700" id="reportSummary">—</div>
      </div>

      <div class="card" style="box-shadow:none;margin:12px 0;background:rgba(0,0,0,.18)">
        <div style="font-weight:1000;font-size:18px;margin-bottom:8px">Episodes</div>
        <div id="reportEpisodes" class="muted" style="font-weight:700">—</div>
      </div>
    </section>
  </div>

  <!-- LOG / EDIT SHEET -->
  <div class="modal" id="logModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h3 id="logTitle" style="margin:8px 0 2px">Log an episode</h3>
          <div class="tiny" id="logModeHint">Draft saves automatically while you type.</div>
        </div>
        <div class="row" style="gap:10px">
          <button class="btn" id="btnCloseTop">Close</button>
          <button class="btn danger" id="btnDiscardTop">Discard</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="field">
        <label>Date/time</label>
        <input type="text" id="fWhen" placeholder="Auto" disabled>
      </div>

      <div class="field">
        <label>Severity (0–10): <span id="sevVal" style="font-weight:1000">5</span></label>
        <input type="range" id="fSev" min="0" max="10" step="1" value="5">
      </div>

      <div class="field">
        <label>Duration</label>
        <div class="chipset" id="durChips"></div>
      </div>

      <div class="field">
        <label>Pain type</label>
        <div class="chipset" id="typeChips"></div>
        <div id="typeOtherWrap" class="field" style="display:none">
          <label>Other pain type</label>
          <input type="text" id="fTypeOther" placeholder="Describe briefly">
        </div>
        <div style="margin-top:10px">
          <div class="guideTitle">Pain type guide</div>
          <div class="guideText" id="typeGuideText">Tap a pain type to see a short guide.</div>
        </div>
      </div>

      <div class="field">
        <label>Location</label>
        <div class="chipset" id="locChips"></div>
        <div id="locOtherWrap" class="field" style="display:none">
          <label>Other location</label>
          <input type="text" id="fLocOther" placeholder="e.g., lower chest">
        </div>
      </div>

      <div class="field">
        <label>Activity at onset</label>
        <div class="chipset" id="actChips"></div>
        <div id="actOtherWrap" class="field" style="display:none">
          <label>Other activity</label>
          <input type="text" id="fActOther" placeholder="Describe">
        </div>
      </div>

      <div class="field">
        <label>Relief</label>
        <div class="chipset" id="relChips"></div>
        <div id="relOtherWrap" class="field" style="display:none">
          <label>Other relief</label>
          <input type="text" id="fRelOther" placeholder="Describe">
        </div>
      </div>

      <div class="field">
        <label>Associated symptoms</label>
        <div class="chipset" id="symChips"></div>
        <div class="tiny" style="margin-top:8px">Tip: choose “None” if there were no other symptoms.</div>
      </div>

      <div class="field">
        <label>Notes</label>
        <textarea id="fNotes" placeholder=""></textarea>
      </div>

      <div class="divider"></div>

      <!-- Big save button before optional vitals (static) -->
      <button class="btn primary full" id="btnSavePrimary">Save log</button>

      <div class="divider"></div>

      <div class="field">
        <label>Optional vitals</label>
        <div class="row">
          <input type="number" id="fHR" placeholder="Heart rate (bpm)" inputmode="numeric">
          <input type="number" id="fBPsys" placeholder="BP systolic" inputmode="numeric">
          <input type="number" id="fBPdia" placeholder="BP diastolic" inputmode="numeric">
        </div>
      </div>

      <div class="actions">
        <button class="btn danger" id="btnDiscard">Discard</button>
        <button class="btn" id="btnClose">Close</button>
        <button class="btn primary" id="btnSave">Save log</button>
      </div>

      <div class="tiny" style="margin-top:10px">
        In an emergency (severe, new, trouble breathing, fainting, heavy sweating, worsening), seek urgent medical care.
      </div>
    </div>
  </div>

  <!-- Show link modal (simple) -->
  <div class="modal" id="linkModal">
    <div class="sheet">
      <h3 style="margin:8px 2px 10px">Your unique link</h3>
      <div class="tiny" style="margin-bottom:8px">Save this link to return to the same logs on any device/browser.</div>
      <textarea id="linkText" readonly style="min-height:120px"></textarea>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnCopyLink2">Copy link</button>
        <button class="btn" id="btnCloseLinkModal">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase (modular CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, collection, query, orderBy, limit, where,
      getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // --------------- YOUR FIREBASE CONFIG ---------------
    // Paste your firebaseConfig exactly as provided by Firebase Console.
    // It is expected to be public. Security is enforced by Firestore rules + design.
    const firebaseConfig = window.firebaseConfig || {
      // TODO: keep your existing config here
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // storageBucket: "...",
      // messagingSenderId: "...",
      // appId: "..."
    };
    // ----------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // UI references
    const syncLabel = document.getElementById("syncLabel");
    const syncDot = document.getElementById("syncDot");

    const viewHome = document.getElementById("viewHome");
    const viewHistory = document.getElementById("viewHistory");
    const viewExport = document.getElementById("viewExport");

    const btnLogNow = document.getElementById("btnLogNow");

    const histList = document.getElementById("histList");
    const histEmpty = document.getElementById("histEmpty");
    const histRange = document.getElementById("histRange");
    const histSev = document.getElementById("histSev");

    const expRange = document.getElementById("expRange");
    const btnRefreshExport = document.getElementById("btnRefreshExport");

    const glance7 = document.getElementById("glance7");
    const glance30 = document.getElementById("glance30");
    const glanceLastSev = document.getElementById("glanceLastSev");
    const glanceCommonActivity = document.getElementById("glanceCommonActivity");

    const uidShort = document.getElementById("uidShort");
    const btnCopyLink = document.getElementById("btnCopyLink");
    const btnLoadExisting = document.getElementById("btnLoadExisting");
    const btnShowLink = document.getElementById("btnShowLink");
    const linkModal = document.getElementById("linkModal");
    const linkText = document.getElementById("linkText");
    const btnCopyLink2 = document.getElementById("btnCopyLink2");
    const btnCloseLinkModal = document.getElementById("btnCloseLinkModal");

    const btnPrint = document.getElementById("btnPrint");
    const btnCSV = document.getElementById("btnCSV");
    const reportGen = document.getElementById("reportGen");
    const reportSummary = document.getElementById("reportSummary");
    const reportEpisodes = document.getElementById("reportEpisodes");

    const btnCreateShare = document.getElementById("btnCreateShare");
    const btnCopyShare = document.getElementById("btnCopyShare");
    const btnRevokeShare = document.getElementById("btnRevokeShare");

    // Log modal
    const logModal = document.getElementById("logModal");
    const logTitle = document.getElementById("logTitle");
    const logModeHint = document.getElementById("logModeHint");
    const btnCloseTop = document.getElementById("btnCloseTop");
    const btnDiscardTop = document.getElementById("btnDiscardTop");
    const btnClose = document.getElementById("btnClose");
    const btnDiscard = document.getElementById("btnDiscard");
    const btnSave = document.getElementById("btnSave");
    const btnSavePrimary = document.getElementById("btnSavePrimary");

    const fWhen = document.getElementById("fWhen");
    const fSev = document.getElementById("fSev");
    const sevVal = document.getElementById("sevVal");
    const fNotes = document.getElementById("fNotes");
    const fHR = document.getElementById("fHR");
    const fBPsys = document.getElementById("fBPsys");
    const fBPdia = document.getElementById("fBPdia");

    const durChips = document.getElementById("durChips");
    const typeChips = document.getElementById("typeChips");
    const locChips = document.getElementById("locChips");
    const actChips = document.getElementById("actChips");
    const relChips = document.getElementById("relChips");
    const symChips = document.getElementById("symChips");

    const typeOtherWrap = document.getElementById("typeOtherWrap");
    const fTypeOther = document.getElementById("fTypeOther");
    const locOtherWrap = document.getElementById("locOtherWrap");
    const fLocOther = document.getElementById("fLocOther");
    const actOtherWrap = document.getElementById("actOtherWrap");
    const fActOther = document.getElementById("fActOther");
    const relOtherWrap = document.getElementById("relOtherWrap");
    const fRelOther = document.getElementById("fRelOther");

    const typeGuideText = document.getElementById("typeGuideText");

    // Bottom tabs
    const tabs = [
      { id:"tabHome", label:"Home", el:null, view:viewHome },
      { id:"tabLog", label:"Log", el:null, view:null },
      { id:"tabHistory", label:"History", el:null, view:viewHistory },
      { id:"tabExport", label:"Export", el:null, view:viewExport },
    ];

    // State
    let VAULT_ID = null;
    let SHARE_TOKEN = null;

    let logsUnsub = null;
    let logsCache = []; // full logs for current vault
    let draft = null;

    let logMode = "new";   // "new" | "edit"
    let editingId = null;  // Firestore doc id when editing

    // ----- Helpers -----
    function setSync(state){
      // state: "Starting…" | "Synced" | "Saving…" | "Offline" | "Sync error"
      syncLabel.textContent = state;
      if(state.includes("Synced")){
        syncDot.style.background = "var(--accent2)";
      }else if(state.includes("Saving") || state.includes("Starting")){
        syncDot.style.background = "var(--warn)";
      }else{
        syncDot.style.background = "var(--danger)";
      }
    }

    function qs(k){ return new URLSearchParams(location.search).get(k); }
    function setQs(k,v){
      const u = new URL(location.href);
      u.searchParams.set(k,v);
      history.replaceState({}, "", u.toString());
    }

    function makeVaultId(){
      // 64 hex
      const a = new Uint8Array(32);
      crypto.getRandomValues(a);
      return [...a].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    function shortId(id){ return id ? id.slice(0,7) : "—"; }

    function vaultRef(){ return doc(db, "vaults", VAULT_ID); }
    function logsCol(){ return collection(db, "vaults", VAULT_ID, "logs"); }
    function draftDoc(){ return doc(db, "vaults", VAULT_ID, "meta", "draft"); }
    function shareDoc(){ return doc(db, "vaults", VAULT_ID, "share", "active"); }

    function makeShareToken(){
      const a = new Uint8Array(18);
      crypto.getRandomValues(a);
      return btoa(String.fromCharCode(...a)).replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
    }

    function fmtDateTime(ts){
      const d = ts instanceof Date ? ts : new Date(ts);
      const date = d.toLocaleDateString(undefined, { month:"short", day:"2-digit", year:"numeric" });
      let time = d.toLocaleTimeString(undefined, { hour:"2-digit", minute:"2-digit" });
      // Ensure space between time and AM/PM won't break oddly
      time = time.replace(" AM", "\u00A0AM").replace(" PM", "\u00A0PM");
      return {date, time, whenLine: `${date} \u2022 ${time}`};
    }

    function daysAgo(n){
      const d = new Date();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - n);
      return d;
    }

    function filterLogs(rangeVal, sevVal){
      const now = new Date();
      let from = null;
      if(rangeVal !== "all"){
        const days = Number(rangeVal);
        from = new Date(now);
        from.setDate(from.getDate() - days);
      }
      return logsCache.filter(l=>{
        const t = l.when?.toDate ? l.when.toDate() : (l.when instanceof Date ? l.when : new Date(l.when));
        if(from && t < from) return false;
        const s = Number(l.severity ?? 0);
        if(sevVal === "mild" && !(s>=1 && s<=3)) return false;
        if(sevVal === "mod" && !(s>=4 && s<=6)) return false;
        if(sevVal === "sev" && !(s>=7 && s<=10)) return false;
        return true;
      }).sort((a,b)=>{
        const ta = a.when?.toMillis ? a.when.toMillis() : new Date(a.when).getTime();
        const tb = b.when?.toMillis ? b.when.toMillis() : new Date(b.when).getTime();
        return tb - ta;
      });
    }

    function csvEscape(v){
      if(v == null) return "";
      const s = String(v);
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    }

    // ----- Chips -----
    function mkChip(container, label, {multi=false, onChange, isOther=false} = {}){
      const el = document.createElement("button");
      el.type = "button";
      el.className = "chip";
      el.textContent = label;
      el.dataset.value = label;
      el.dataset.other = isOther ? "1" : "0";
      el.addEventListener("click", ()=>{
        if(multi){
          const on = el.classList.toggle("on");
          onChange?.();
        }else{
          [...container.querySelectorAll(".chip")].forEach(c=>c.classList.remove("on"));
          el.classList.add("on");
          onChange?.();
        }
      });
      container.appendChild(el);
      return el;
    }

    function getSingle(container){
      const on = container.querySelector(".chip.on");
      return on ? on.dataset.value : null;
    }
    function getMulti(container){
      return [...container.querySelectorAll(".chip.on")].map(x=>x.dataset.value);
    }
    function setSingle(container, val){
      [...container.querySelectorAll(".chip")].forEach(c=>{
        c.classList.toggle("on", c.dataset.value === val);
      });
    }
    function setMulti(container, arr){
      const set = new Set(arr || []);
      [...container.querySelectorAll(".chip")].forEach(c=>{
        c.classList.toggle("on", set.has(c.dataset.value));
      });
    }

    const painTypeGuides = {
      "Pressure":"Tight, heavy, squeezing feeling (like weight on chest).",
      "Sharp":"Stabbing or needle-like pain, often well-localized.",
      "Burning":"Hot or acidic burning feeling (can overlap with reflux).",
      "Aching":"Dull soreness or ache rather than sharp pain.",
      "Fluttering":"More like a strange sensation/palpitations than pain.",
      "Other":"Use this if it doesn’t match. Keep it short and specific."
    };

    function buildChips(){
      durChips.innerHTML = "";
      ["Ongoing","< 5 min","5–15 min","15–60 min","> 1 hr"].forEach(v=>mkChip(durChips, v));

      typeChips.innerHTML = "";
      ["Pressure","Sharp","Burning","Aching","Fluttering","Other"].forEach(v=>{
        mkChip(typeChips, v, {
          onChange: ()=>{
            const sel = getSingle(typeChips);
            typeOtherWrap.style.display = (sel==="Other") ? "block" : "none";
            typeGuideText.textContent = painTypeGuides[sel] || "Tap a pain type to see a short guide.";
          },
          isOther: v==="Other"
        });
      });

      locChips.innerHTML = "";
      ["Center","Left","Right","Upper abdomen","Other"].forEach(v=>{
        mkChip(locChips, v, { onChange: ()=>{
          locOtherWrap.style.display = (getSingle(locChips)==="Other") ? "block" : "none";
        }});
      });

      actChips.innerHTML = "";
      ["Rest","Walking","Stairs","Exercise","After meal","Stress","Sleeping","Other"].forEach(v=>{
        mkChip(actChips, v, { onChange: ()=>{
          actOtherWrap.style.display = (getSingle(actChips)==="Other") ? "block" : "none";
        }});
      });

      relChips.innerHTML = "";
      ["Rest","Breathing","Antacid","Nitro","Painkiller","None","Other"].forEach(v=>{
        mkChip(relChips, v, { onChange: ()=>{
          relOtherWrap.style.display = (getSingle(relChips)==="Other") ? "block" : "none";
        }});
      });

      symChips.innerHTML = "";
      ["Shortness of breath","Sweating","Nausea","Dizziness","Palpitations","Radiation (arm/jaw/back)","None"].forEach(v=>{
        mkChip(symChips, v, {multi:true, onChange: ()=>{
          // If None selected, clear others; if any other selected, clear None
          const arr = getMulti(symChips);
          if(arr.includes("None") && arr.length>1){
            setMulti(symChips, ["None"]);
          }else if(arr.length>=1 && !arr.includes("None")){
            // ok
          }else{
            // ok
          }
        }});
      });
    }

    // ----- Views -----
    function showView(which){
      viewHome.style.display = (which==="home") ? "" : "none";
      viewHistory.style.display = (which==="history") ? "" : "none";
      viewExport.style.display = (which==="export") ? "" : "none";
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      const map = {home:"tabHome", history:"tabHistory", export:"tabExport"};
      if(map[which]) document.getElementById(map[which]).classList.add("active");
      window.scrollTo({top:0, behavior:"smooth"});
      if(which==="history") renderHistory();
      if(which==="export") renderExport();
    }

    // ----- Draft + Log modal -----
    function openLogModal(mode, logObj=null){
      logMode = mode;
      editingId = logObj?.id || null;
      logTitle.textContent = mode==="edit" ? "Edit episode" : "Log an episode";
      logModeHint.textContent = mode==="edit" ? "Edit and save changes." : "Draft saves automatically while you type.";

      const now = new Date();
      const {whenLine} = fmtDateTime(now);
      fWhen.value = mode==="edit" ? fmtDateTime(logObj.when?.toDate ? logObj.when.toDate() : logObj.when).whenLine : whenLine;

      // Reset fields
      fSev.value = (logObj?.severity ?? 5);
      sevVal.textContent = String(fSev.value);
      setSingle(durChips, logObj?.duration ?? "Ongoing");

      setSingle(typeChips, logObj?.painType ?? "Pressure");
      typeGuideText.textContent = painTypeGuides[getSingle(typeChips)] || "Tap a pain type to see a short guide.";
      fTypeOther.value = logObj?.painTypeOther ?? "";
      typeOtherWrap.style.display = (getSingle(typeChips)==="Other") ? "block" : "none";

      setSingle(locChips, logObj?.location ?? "Center");
      fLocOther.value = logObj?.locationOther ?? "";
      locOtherWrap.style.display = (getSingle(locChips)==="Other") ? "block" : "none";

      setSingle(actChips, logObj?.activity ?? "Rest");
      fActOther.value = logObj?.activityOther ?? "";
      actOtherWrap.style.display = (getSingle(actChips)==="Other") ? "block" : "none";

      setSingle(relChips, logObj?.relief ?? "None");
      fRelOther.value = logObj?.reliefOther ?? "";
      relOtherWrap.style.display = (getSingle(relChips)==="Other") ? "block" : "none";

      setMulti(symChips, logObj?.symptoms ?? []);
      fNotes.value = logObj?.notes ?? "";

      fHR.value = logObj?.hr ?? "";
      fBPsys.value = logObj?.bpSys ?? "";
      fBPdia.value = logObj?.bpDia ?? "";

      logModal.classList.add("on");
    }

    function closeLogModal(){
      logModal.classList.remove("on");
    }

    function currentDraftObject(){
      return {
        updatedAt: serverTimestamp(),
        severity: Number(fSev.value),
        duration: getSingle(durChips),
        painType: getSingle(typeChips),
        painTypeOther: (getSingle(typeChips)==="Other") ? (fTypeOther.value || "") : "",
        location: getSingle(locChips),
        locationOther: (getSingle(locChips)==="Other") ? (fLocOther.value || "") : "",
        activity: getSingle(actChips),
        activityOther: (getSingle(actChips)==="Other") ? (fActOther.value || "") : "",
        relief: getSingle(relChips),
        reliefOther: (getSingle(relChips)==="Other") ? (fRelOther.value || "") : "",
        symptoms: getMulti(symChips),
        notes: fNotes.value || "",
        hr: fHR.value ? Number(fHR.value) : null,
        bpSys: fBPsys.value ? Number(fBPsys.value) : null,
        bpDia: fBPdia.value ? Number(fBPdia.value) : null
      };
    }

    let draftSaveTimer = null;
    function scheduleDraftSave(){
      if(logMode !== "new") return; // only autosave drafts in new mode
      clearTimeout(draftSaveTimer);
      draftSaveTimer = setTimeout(async ()=>{
        try{
          setSync("Saving…");
          await setDoc(draftDoc(), currentDraftObject(), {merge:true});
          setSync("Synced");
        }catch(e){
          console.error(e);
          setSync("Sync error");
        }
      }, 350);
    }

    async function discardDraft(){
      const ok = confirm("Discard this draft?");
      if(!ok) return;
      try{
        setSync("Saving…");
        await deleteDoc(draftDoc()).catch(()=>{});
        setSync("Synced");
      }catch(e){
        console.error(e);
        setSync("Sync error");
      }
      closeLogModal();
    }

    async function saveLog(){
      // Works for both NEW and EDIT
      try{
        setSync("Saving…");
        const payload = {
          when: (logMode==="edit" && editingId)
            ? (logsCache.find(x=>x.id===editingId)?.when || serverTimestamp())
            : serverTimestamp(),
          createdAt: (logMode==="edit" && editingId) ? undefined : serverTimestamp(),
          updatedAt: serverTimestamp(),
          severity: Number(fSev.value),
          duration: getSingle(durChips),
          painType: getSingle(typeChips),
          painTypeOther: (getSingle(typeChips)==="Other") ? (fTypeOther.value || "") : "",
          location: getSingle(locChips),
          locationOther: (getSingle(locChips)==="Other") ? (fLocOther.value || "") : "",
          activity: getSingle(actChips),
          activityOther: (getSingle(actChips)==="Other") ? (fActOther.value || "") : "",
          relief: getSingle(relChips),
          reliefOther: (getSingle(relChips)==="Other") ? (fRelOther.value || "") : "",
          symptoms: getMulti(symChips),
          notes: fNotes.value || "",
          hr: fHR.value ? Number(fHR.value) : null,
          bpSys: fBPsys.value ? Number(fBPsys.value) : null,
          bpDia: fBPdia.value ? Number(fBPdia.value) : null
        };

        if(logMode === "edit" && editingId){
          const ref = doc(db, "vaults", VAULT_ID, "logs", editingId);
          // remove undefined keys
          Object.keys(payload).forEach(k=>payload[k]===undefined && delete payload[k]);
          await updateDoc(ref, payload);
        }else{
          // NEW
          Object.keys(payload).forEach(k=>payload[k]===undefined && delete payload[k]);
          await addDoc(logsCol(), payload);
          // clear draft after save
          await deleteDoc(draftDoc()).catch(()=>{});
        }

        setSync("Synced");
        closeLogModal();
        renderHistory();
        renderExport();
        renderHomeGlance();
      }catch(e){
        console.error(e);
        setSync("Sync error");
        alert("Could not save. Check connection/rules.");
      }
    }

    async function deleteEditingLog(){
      if(!(logMode==="edit" && editingId)) return;
      const ok = confirm("Delete this log?");
      if(!ok) return;
      try{
        setSync("Saving…");
        await deleteDoc(doc(db, "vaults", VAULT_ID, "logs", editingId));
        setSync("Synced");
        closeLogModal();
        renderHistory();
        renderExport();
        renderHomeGlance();
      }catch(e){
        console.error(e);
        setSync("Sync error");
        alert("Could not delete. Check connection/rules.");
      }
    }

    // ----- Rendering -----
    function renderHistory(){
      const rangeVal = histRange.value;
      const sevVal = histSev.value;
      const list = filterLogs(rangeVal, sevVal);

      histList.innerHTML = "";
      histEmpty.style.display = list.length ? "none" : "";

      list.forEach(l=>{
        const t = l.when?.toDate ? l.when.toDate() : (l.when instanceof Date ? l.when : new Date(l.when));
        const {whenLine} = fmtDateTime(t);

        const card = document.createElement("div");
        card.className = "logcard";
        card.dataset.id = l.id;

        card.innerHTML = `
          <div class="loghead">
            <div style="min-width:0">
              <div class="logwhen">${whenLine}</div>
              <div class="logmeta">${(l.painType || "—")} · ${(l.location || "—")} · ${(l.activity || "—")}</div>
            </div>
            <div class="logright">
              <div class="sev">${Number(l.severity ?? 0)}/10</div>
              <div class="dur">${l.duration || "—"}</div>
            </div>
          </div>
        `;

        card.addEventListener("click", ()=>{
          // Open in edit mode
          openLogModal("edit", l);
        });

        histList.appendChild(card);
      });
    }

    function renderHomeGlance(){
      const last7 = logsCache.filter(l=>{
        const t = l.when?.toDate ? l.when.toDate() : new Date(l.when);
        return t >= daysAgo(7);
      });
      const last30 = logsCache.filter(l=>{
        const t = l.when?.toDate ? l.when.toDate() : new Date(l.when);
        return t >= daysAgo(30);
      });

      glance7.textContent = String(last7.length);
      glance30.textContent = String(last30.length);

      const sorted = [...logsCache].sort((a,b)=>{
        const ta = a.when?.toMillis ? a.when.toMillis() : new Date(a.when).getTime();
        const tb = b.when?.toMillis ? b.when.toMillis() : new Date(b.when).getTime();
        return tb-ta;
      });
      const last = sorted[0];
      glanceLastSev.textContent = last ? `${Number(last.severity ?? 0)}/10` : "—";

      // Most common onset activity in last 30 days
      const counts = new Map();
      last30.forEach(l=>{
        const k = l.activity || "—";
        counts.set(k, (counts.get(k) || 0) + 1);
      });
      let best = null, bestN = 0;
      for(const [k,n] of counts.entries()){
        if(n > bestN){ bestN = n; best = k; }
      }
      glanceCommonActivity.textContent = best ? `${best}` : "—";
    }

    function renderExport(){
      const rangeVal = expRange.value;
      const list = filterLogs(rangeVal, "all");

      reportGen.textContent = new Date().toLocaleString();
      if(!list.length){
        reportSummary.textContent = "No episodes in this range.";
        reportEpisodes.textContent = "—";
        return;
      }

      const total = list.length;
      const avg = (list.reduce((s,l)=>s+Number(l.severity??0),0)/total).toFixed(1);
      const max = Math.max(...list.map(l=>Number(l.severity??0)));
      // common activity
      const counts = new Map();
      list.forEach(l=>{
        const k = l.activity || "—";
        counts.set(k, (counts.get(k)||0)+1);
      });
      let best=null,bestN=0;
      for(const [k,n] of counts.entries()){ if(n>bestN){bestN=n;best=k;} }

      reportSummary.textContent = `Total episodes: ${total}. Average severity: ${avg}/10 (max ${max}/10). Most common onset activity: ${best} (${bestN}).`;

      // Episodes mini-table text (kept simple for mobile)
      reportEpisodes.innerHTML = list.slice(0, 25).map(l=>{
        const t = l.when?.toDate ? l.when.toDate() : new Date(l.when);
        const {date,time} = fmtDateTime(t);
        const meta = `${(l.painType||"—")} · ${(l.location||"—")} · ${(l.activity||"—")}`;
        const dur = l.duration || "—";
        return `<div style="padding:8px 0;border-top:1px solid rgba(255,255,255,.08)">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div style="min-width:0">
              <div style="font-weight:900;white-space:nowrap">${date} · ${time}</div>
              <div class="tiny" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${meta}</div>
            </div>
            <div style="text-align:right;white-space:nowrap;font-weight:900">${Number(l.severity??0)}/10</div>
          </div>
          <div class="tiny" style="margin-top:2px">Duration: ${dur}</div>
        </div>`;
      }).join("");
    }

    // ----- Share link (active + reverse lookup) -----
    async function createOrReplaceShareLink(){
      if(!VAULT_ID) return;
      setSync("Saving…");
      try{
        const token = makeShareToken();

        await setDoc(shareDoc(), { token, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, {merge:false});
        await setDoc(doc(db, "shares", token), { vaultId: VAULT_ID, createdAt: serverTimestamp() }, {merge:false});

        SHARE_TOKEN = token;
        updateShareUI();
        setSync("Synced");
      }catch(e){
        console.error(e);
        setSync("Sync error (share)");
        alert("Could not create share link. Check rules.");
      }
    }
    async function revokeShareLink(){
      if(!VAULT_ID) return;
      const ok = confirm("Revoke the share link?");
      if(!ok) return;
      setSync("Saving…");
      try{
        if(SHARE_TOKEN){
          await deleteDoc(doc(db, "shares", SHARE_TOKEN)).catch(()=>{});
        }
        await deleteDoc(shareDoc()).catch(()=>{});
        SHARE_TOKEN = null;
        updateShareUI();
        setSync("Synced");
      }catch(e){
        console.error(e);
        setSync("Sync error (share)");
        alert("Could not revoke share link. Check rules.");
      }
    }

    function updateShareUI(){
      const has = !!SHARE_TOKEN;
      btnCopyShare.disabled = !has;
      btnRevokeShare.disabled = !has;
    }

    // ----- Export actions -----
    function downloadCSV(){
      const rangeVal = expRange.value;
      const list = filterLogs(rangeVal, "all");
      const header = [
        "when","severity","duration","painType","painTypeOther","location","locationOther",
        "activity","activityOther","relief","reliefOther","symptoms","notes","hr","bpSys","bpDia"
      ];
      const lines = [header.join(",")];
      list.forEach(l=>{
        const t = l.when?.toDate ? l.when.toDate() : new Date(l.when);
        const row = [
          t.toISOString(),
          l.severity ?? "",
          l.duration ?? "",
          l.painType ?? "",
          l.painTypeOther ?? "",
          l.location ?? "",
          l.locationOther ?? "",
          l.activity ?? "",
          l.activityOther ?? "",
          l.relief ?? "",
          l.reliefOther ?? "",
          (l.symptoms || []).join("; "),
          l.notes ?? "",
          l.hr ?? "",
          l.bpSys ?? "",
          l.bpDia ?? ""
        ].map(csvEscape).join(",");
        lines.push(row);
      });

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `chest-pain-${rangeVal}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 800);
    }

    function printPDF(){
      window.print();
    }

    // ----- Unique link workflow -----
    function uniqueLink(){
      const u = new URL(location.origin + location.pathname);
      u.searchParams.set("uid", VAULT_ID);
      return u.toString();
    }

    function copyText(text){
      return navigator.clipboard.writeText(text).catch(async ()=>{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      });
    }

    function openShowLink(){
      linkText.value = uniqueLink();
      linkModal.classList.add("on");
    }

    async function loadExistingPrompt(){
      const entered = prompt("Paste your saved link or enter the ID:");
      if(!entered) return;
      try{
        let id = entered.trim();
        if(id.includes("uid=")){
          const u = new URL(id);
          id = u.searchParams.get("uid") || id;
        }
        if(!/^[a-f0-9]{16,128}$/i.test(id)){
          alert("That doesn’t look like a valid ID.");
          return;
        }
        VAULT_ID = id;
        setQs("uid", VAULT_ID);
        uidShort.textContent = shortId(VAULT_ID);
        await initVaultStreams();
        alert("Loaded.");
      }catch(e){
        console.error(e);
        alert("Could not load that ID.");
      }
    }

    // ----- Streams -----
    async function initVaultStreams(){
      if(!VAULT_ID) return;

      // Listen logs
      if(logsUnsub) logsUnsub();
      const qy = query(logsCol(), orderBy("when","desc"), limit(500));
      logsUnsub = onSnapshot(qy, (snap)=>{
        logsCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        setSync("Synced");
        renderHomeGlance();
        if(viewHistory.style.display !== "none") renderHistory();
        if(viewExport.style.display !== "none") renderExport();
      }, (err)=>{
        console.error(err);
        setSync("Sync error");
      });

      // Draft
      onSnapshot(draftDoc(), (snap)=>{
        draft = snap.exists() ? snap.data() : null;
      });

      // Share active
      onSnapshot(shareDoc(), (snap)=>{
        SHARE_TOKEN = snap.exists() ? (snap.data().token || null) : null;
        updateShareUI();
      });
    }

    // ----- Tabs UI setup -----
    function mountTabbar(){
      const tabsWrap = document.createElement("div");
      tabsWrap.className = "tabs";
      tabsWrap.innerHTML = `<div class="tabbar">
        <button class="tab active" id="tabHome">Home</button>
        <button class="tab" id="tabLog">Log</button>
        <button class="tab" id="tabHistory">History</button>
        <button class="tab" id="tabExport">Export</button>
      </div>`;
      document.body.appendChild(tabsWrap);

      document.getElementById("tabHome").addEventListener("click", ()=>showView("home"));
      document.getElementById("tabHistory").addEventListener("click", ()=>showView("history"));
      document.getElementById("tabExport").addEventListener("click", ()=>showView("export"));
      document.getElementById("tabLog").addEventListener("click", ()=>{
        openLogModal("new");
      });
    }

    // ----- Event wiring -----
    function wire(){
      buildChips();
      mountTabbar();

      // Severity label + autosave draft
      fSev.addEventListener("input", ()=>{
        sevVal.textContent = String(fSev.value);
        scheduleDraftSave();
      });

      // Draft autosave fields (new mode only)
      [fNotes,fHR,fBPsys,fBPdia,fTypeOther,fLocOther,fActOther,fRelOther].forEach(el=>{
        el.addEventListener("input", scheduleDraftSave);
      });
      // chips autosave
      [durChips,typeChips,locChips,actChips,relChips,symChips].forEach(container=>{
        container.addEventListener("click", scheduleDraftSave);
      });

      // Open log from home
      btnLogNow.addEventListener("click", ()=>openLogModal("new"));

      // Close/discard/save buttons (ensure they always work)
      const closeAll = ()=>closeLogModal();
      btnClose.addEventListener("click", closeAll);
      btnCloseTop.addEventListener("click", closeAll);

      btnDiscard.addEventListener("click", ()=>{
        if(logMode==="edit"){
          // In edit mode, discard means "Delete" is explicit; discard just closes
          closeLogModal();
        }else{
          discardDraft();
        }
      });
      btnDiscardTop.addEventListener("click", ()=>{
        if(logMode==="edit"){
          // In edit mode, top "Discard" becomes "Delete"
          deleteEditingLog();
        }else{
          discardDraft();
        }
      });

      btnSave.addEventListener("click", saveLog);
      btnSavePrimary.addEventListener("click", saveLog);

      // When entering edit mode, change top-right discard label to Delete
      const observer = new MutationObserver(()=>{
        if(logMode==="edit"){
          btnDiscardTop.textContent = "Delete";
          btnDiscardTop.classList.add("danger");
          btnDiscard.textContent = "Close";
        }else{
          btnDiscardTop.textContent = "Discard";
          btnDiscardTop.classList.remove("danger");
          btnDiscard.textContent = "Discard";
        }
      });
      observer.observe(logModal, {attributes:true, attributeFilter:["class"]});

      // History filters
      histRange.addEventListener("change", renderHistory);
      histSev.addEventListener("change", renderHistory);

      // Export
      btnRefreshExport.addEventListener("click", renderExport);
      expRange.addEventListener("change", renderExport);
      btnCSV.addEventListener("click", downloadCSV);
      btnPrint.addEventListener("click", printPDF);

      // Share
      btnCreateShare.addEventListener("click", createOrReplaceShareLink);
      btnRevokeShare.addEventListener("click", revokeShareLink);
      btnCopyShare.addEventListener("click", ()=>{
        if(!SHARE_TOKEN) return;
        const u = new URL(location.origin + location.pathname);
        u.searchParams.set("share", SHARE_TOKEN);
        copyText(u.toString());
        alert("Copied share link.");
      });

      // Unique link buttons
      btnCopyLink.addEventListener("click", ()=>{
        copyText(uniqueLink());
        alert("Copied.");
      });
      btnCopyLink2.addEventListener("click", ()=>{
        copyText(uniqueLink());
        alert("Copied.");
      });
      btnShowLink.addEventListener("click", openShowLink);
      btnCloseLinkModal.addEventListener("click", ()=>linkModal.classList.remove("on"));
      btnLoadExisting.addEventListener("click", loadExistingPrompt);
    }

    // ----- Boot -----
    async function boot(){
      setSync("Starting…");

      // Anon auth is required for Firestore security rules to work safely.
      // Even though "no login", this is invisible to the user.
      await signInAnonymously(auth);

      onAuthStateChanged(auth, async (u)=>{
        if(!u) return;

        // Determine vault id:
        // 1) URL ?uid=
        // 2) localStorage lastVaultId
        // 3) generate new
        const urlUid = qs("uid");
        const saved = localStorage.getItem("cpt_lastVaultId");
        VAULT_ID = urlUid || saved || makeVaultId();

        localStorage.setItem("cpt_lastVaultId", VAULT_ID);
        setQs("uid", VAULT_ID);

        uidShort.textContent = shortId(VAULT_ID);

        await initVaultStreams();
        wire();
        renderHomeGlance();
        showView("home");

        setSync("Synced");
      });

      // Support shared view (read-only report) if ?share=
      const share = qs("share");
      if(share){
        // For simplicity, just resolve and load that vault, then show Export.
        try{
          setSync("Starting…");
          const sdoc = await getDoc(doc(db, "shares", share));
          if(!sdoc.exists()){
            alert("Share link not found.");
            return;
          }
          const {vaultId} = sdoc.data();
          if(vaultId){
            VAULT_ID = vaultId;
            uidShort.textContent = shortId(VAULT_ID);
            await initVaultStreams();
            showView("export");
            setSync("Synced");
          }
        }catch(e){
          console.error(e);
          setSync("Sync error");
          alert("Could not load share link.");
        }
      }
    }

    boot();
  </script>
</body>
</html>
