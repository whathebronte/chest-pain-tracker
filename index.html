<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Chest Pain Tracker</title>
  <meta name="description" content="Track chest pain episodes, export summaries, and share a read-only report link." />
  <style>
    :root{
      --bg:#0b0c10;
      --card:#12141b;
      --card2:#0f1117;
      --text:#f3f4f6;
      --muted:#a7acb8;
      --line:#252a36;
      --good:#1fda8a;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --accent:#7aa2ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
      --pad2:22px;
      --w: 980px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(900px 600px at 30% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 10%, rgba(31,218,138,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.35;
    }
    a{color:inherit}
    .wrap{max-width:var(--w); margin:0 auto; padding:18px 14px 90px;}
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(11,12,16,.65);
      border-bottom:1px solid rgba(37,42,54,.7);
    }
    .topbar-inner{max-width:var(--w); margin:0 auto; padding:12px 14px; display:flex; gap:10px; align-items:center;}
    .brand{display:flex; gap:10px; align-items:center;}
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(122,162,255,.9), rgba(31,218,138,.9));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .title{display:flex; flex-direction:column}
    .title b{font-size:14px; letter-spacing:.2px}
    .title span{font-size:12px; color:var(--muted)}
    .spacer{flex:1}
    .nav-desktop{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    button{
      appearance:none; border:1px solid var(--line);
      background: rgba(18,20,27,.85);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.12s transform, .12s background, .12s border-color;
      font-weight:800;
      font-size:13px;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.45)}
    button:active{transform: translateY(0px)}
    button.primary{
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(122,162,255,.65));
      border-color: rgba(122,162,255,.8);
      color:#071021;
    }
    button.ghost{background: transparent;}
    button.danger{
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.45);
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(18,20,27,.6);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--muted)}
    .pill.good .dot{background:var(--good)}
    .pill.warn .dot{background:var(--warn)}
    .pill.bad .dot{background:var(--bad)}
    .pill span{color:var(--text); font-weight:900; font-size:12px}

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(18,20,27,.92), rgba(15,17,23,.92));
      border:1px solid rgba(37,42,54,.9);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: var(--pad2);
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .section-title h2{margin:0; font-size:16px}
    .card p{margin:0; color:var(--muted)}

    /* Mobile header alignment fix */
    @media (max-width: 560px){
      .section-title{
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      .section-title .row{
        width:100%;
        justify-content:space-between !important;
      }
      .section-title .row > *{
        flex:1 1 auto;
      }
      .section-title select{min-width:0}
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .muted{color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 600px){ .kpi{grid-template-columns:1fr} }
    .k{
      border:1px solid rgba(37,42,54,.9);
      background: rgba(18,20,27,.5);
      border-radius:14px;
      padding:12px;
    }
    .k b{display:block; font-size:18px}
    .k span{font-size:12px; color:var(--muted)}

    .banner{
      margin-top:12px;
      border-radius:14px;
      border:1px solid rgba(255,204,102,.35);
      background: rgba(255,204,102,.08);
      padding:12px;
      font-size:13px;
    }
    .banner b{display:block; margin-bottom:6px}

    .subcard{
      margin-top:12px;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(37,42,54,.9);
      background: rgba(18,20,27,.35);
    }
    .subcard h3{margin:0 0 10px 0; font-size:14px}

    .view{display:none}
    .view.active{display:block}

    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .item{
      border:1px solid rgba(37,42,54,.9);
      border-radius:14px;
      background: rgba(18,20,27,.4);
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      transition: .12s border-color, .12s transform;
    }
    .item:hover{transform:translateY(-1px); border-color: rgba(122,162,255,.45)}
    .item b{display:block; font-size:13px}
    .item span{display:block; font-size:12px; color:var(--muted)}
    .item .right{text-align:right; min-width:90px; display:flex; flex-direction:column; justify-content:center;}

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top:10px;
      font-size:13px;
    }
    .table th, .table td{
      border-bottom:1px solid rgba(37,42,54,.8);
      padding:10px 8px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-size:12px; font-weight:900}

    /* Bottom tab bar (mobile) */
    .tabbar{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(11,12,16,.82);
      border-top:1px solid rgba(37,42,54,.7);
      backdrop-filter: blur(12px);
      z-index:50;
      display:none;
    }
    .tabbar-inner{
      max-width:var(--w);
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
      align-items:center;
    }
    .tabbtn{
      padding:10px 10px;
      border-radius:14px;
      font-size:12px;
      font-weight:900;
      background: rgba(18,20,27,.55);
      border:1px solid rgba(37,42,54,.9);
      color: var(--text);
    }
    .tabbtn.active{border-color: rgba(122,162,255,.7); background: rgba(122,162,255,.12);}
    .tabbtn.log{
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(122,162,255,.65));
      border-color: rgba(122,162,255,.85);
      color:#071021;
    }

    @media (max-width: 860px){
      .nav-desktop{display:none;}
      .tabbar{display:block;}
      .wrap{padding-bottom: 120px;}
    }

    /* Modal bottom sheet */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:60;
      padding: 0 10px calc(10px + env(safe-area-inset-bottom));
    }
    .modal-backdrop.show{display:flex;}
    .sheet{
      width: min(var(--w), 980px);
      background: linear-gradient(180deg, rgba(18,20,27,.98), rgba(15,17,23,.98));
      border:1px solid rgba(37,42,54,.95);
      border-radius: 18px;
      box-shadow: var(--shadow);
      max-height: 88vh;
      overflow:auto;
      padding: 14px 14px 12px;
      position:relative;
    }
    .sheet-header{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      position: sticky; top:0;
      padding: 10px 6px;
      background: rgba(18,20,27,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(37,42,54,.65);
      border-radius: 14px;
      margin-bottom: 10px;
      z-index:2;
    }
    .sheet-header b{font-size:14px}
    .sheet-header .sub{font-size:12px;color:var(--muted); font-weight:800}
    .sheet-actions{display:flex; gap:8px; align-items:center}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding: 6px;
      padding-bottom: 76px; /* room for sticky footer */
    }
    @media (max-width: 820px){ .form{grid-template-columns:1fr} }

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:900}
    input, select, textarea{
      width:100%;
      border:1px solid rgba(37,42,54,.9);
      border-radius:12px;
      background: rgba(11,12,16,.55);
      color:var(--text);
      padding:10px 11px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(122,162,255,.65)}
    .help{font-size:12px; color:var(--muted); margin-top:6px;}
    .chips{display:flex; flex-wrap:wrap; gap:8px;}
    .chip{
      border:1px solid rgba(37,42,54,.9);
      background: rgba(18,20,27,.55);
      color: var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.12s transform, .12s border-color, .12s background;
      font-weight:900;
    }
    .chip:hover{transform:translateY(-1px); border-color: rgba(122,162,255,.45)}
    .chip.selected{
      border-color: rgba(31,218,138,.7);
      background: rgba(31,218,138,.12);
    }

    /* Sticky footer action bar inside sheet */
    .sheet-footer{
      position: sticky;
      bottom: 0;
      z-index: 3;
      background: rgba(18,20,27,.96);
      border-top: 1px solid rgba(37,42,54,.75);
      backdrop-filter: blur(10px);
      padding: 10px 10px;
      border-radius: 14px;
      margin: 0 6px 6px;
      display:flex;
      gap:8px;
      justify-content:space-between;
      align-items:center;
    }
    .footer-left, .footer-right{display:flex; gap:8px; align-items:center}

    /* Mobile-friendly report: table on desktop, cards on mobile */
    .report-cards { display:none; margin-top:10px; }
    .report-card{
      border:1px solid rgba(37,42,54,.9);
      background: rgba(18,20,27,.4);
      border-radius:14px;
      padding:12px;
    }
    .report-card + .report-card{ margin-top:10px; }
    .report-kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      font-size:13px;
    }
    .report-kv div:nth-child(odd){ color: var(--muted); font-weight:900; }
    .report-kv div:nth-child(even){ color: var(--text); font-weight:800; }

    @media (max-width: 720px){
      .table{ display:none; }
      .report-cards{ display:block; }
      .report-kv{ grid-template-columns: 110px 1fr; }
    }

    /* === Refinement 1: elder-friendly severity slider === */
    input[type="range"]{
      height: 36px; /* adds touch-friendly vertical area */
      background: transparent;
      padding: 0;
      border: 0;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 12px;                 /* thicker bar */
      border-radius: 999px;
      background: rgba(122,162,255,.22);
      border: 1px solid rgba(122,162,255,.25);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      width: 28px;
      height: 28px;                 /* bigger grab handle */
      border-radius: 999px;
      margin-top: -9px;             /* centers thumb on 12px track */
      background: rgba(122,162,255,.95);
      border: 2px solid rgba(255,255,255,.55);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }
    input[type="range"]::-moz-range-track{
      height: 12px;
      border-radius: 999px;
      background: rgba(122,162,255,.22);
      border: 1px solid rgba(122,162,255,.25);
    }
    input[type="range"]::-moz-range-thumb{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: rgba(122,162,255,.95);
      border: 2px solid rgba(255,255,255,.55);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    /* Print */
    @media print{
      body{background:#fff;color:#111}
      .topbar, .tabbar, .no-print, .modal-backdrop{display:none !important}
      .wrap{max-width:100%;padding:0}
      .card{box-shadow:none;border:0;border-radius:0;background:#fff;padding:0}
      .subcard{border:1px solid #ddd;background:#fff}
      .table th, .table td{border-bottom:1px solid #ddd}
      .muted, .small{color:#444}
      a{color:#111;text-decoration:none}
      .report-cards{display:none !important}
      .table{display:table !important}
    }
  </style>
</head>

<body>
  <div class="topbar no-print">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Chest Pain Tracker</b>
          <span>Log episodes • Export & share reports</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="nav-desktop">
        <button id="navHome" class="ghost">Home</button>
        <button id="navLog" class="primary">Log</button>
        <button id="navHistory">History</button>
        <button id="navExport">Export</button>
      </div>

      <div id="syncPill" class="pill warn" title="Sync status">
        <div class="dot"></div>
        <span id="syncText">Starting…</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HOME -->
    <div id="viewHome" class="view active">
      <div class="grid">
        <div class="card">
          <div class="section-title">
            <h2>Home</h2>
          </div>

          <div class="row">
            <button class="primary" id="homeLogNow" style="width:100%; padding:14px 16px; font-size:15px; border-radius:16px;">
              Log Chest Pain
            </button>
          </div>

          <div id="resumeDraftBox" class="subcard" style="display:none;">
            <h3>Resume draft</h3>
            <div class="muted" id="draftSummary"></div>
            <div class="row" style="margin-top:10px;">
              <button class="primary" id="resumeDraftBtn">Resume</button>
              <button class="danger" id="discardDraftBtn">Discard</button>
            </div>
          </div>

          <div class="banner">
            <b>Safety note</b>
            If chest pain is severe, new, or with trouble breathing, fainting, heavy sweating, or worsening symptoms, seek urgent medical care.
          </div>
        </div>

        <div class="card">
          <div class="section-title"><h2>At a glance</h2></div>

          <div class="kpi">
            <div class="k"><b id="kpi7d">0</b><span>Episodes (last 7 days)</span></div>
            <div class="k"><b id="kpi30d">0</b><span>Episodes (last 30 days)</span></div>
            <div class="k"><b id="kpiLast">—</b><span>Last severity</span></div>
          </div>

          <div class="subcard">
            <h3>Most common onset activity (30 days)</h3>
            <div class="muted" id="kpiCommonActivity">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="viewHistory" class="view">
      <div class="card">
        <div class="section-title">
          <h2>History</h2>
          <div class="row no-print" style="justify-content:flex-end;">
            <select id="historyRange">
              <option value="7" selected>Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="365">Last 12 months</option>
              <option value="all">All time</option>
            </select>
            <select id="historySeverity">
              <option value="all" selected>All severities</option>
              <option value="7+">7–10</option>
              <option value="4+">4–10</option>
              <option value="0-3">0–3</option>
            </select>
          </div>
        </div>

        <div class="small muted">Tap an episode to edit.</div>
        <div id="historyList" class="list"></div>
      </div>
    </div>

    <!-- EXPORT -->
    <div id="viewExport" class="view">
      <div class="card">
        <div class="section-title">
          <h2>Export</h2>
          <div class="row no-print" style="justify-content:flex-end;">
            <select id="exportRange">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="365">Last 12 months</option>
              <option value="all">All time</option>
            </select>
            <button id="refreshReportBtn">Refresh</button>
          </div>
        </div>

        <div class="subcard no-print">
          <h3>Clinician summary (Print to PDF)</h3>
          <div class="row" style="margin-top:10px;">
            <button class="primary" id="printBtn">Print / Save PDF</button>
            <button id="downloadCsvBtn">Download CSV</button>
          </div>
        </div>

        <div class="subcard no-print">
          <h3>Share a read-only report link</h3>
          <div class="small muted">One active link only. No expiry. Revocable anytime.</div>
          <div class="row" style="margin-top:10px;">
            <button class="primary" id="createShareBtn">Create / Replace share link</button>
            <button id="copyShareBtn" style="display:none;">Copy share link</button>
            <button id="revokeShareBtn" class="danger" style="display:none;">Revoke share link</button>
          </div>
          <div id="shareLinkBox" class="small mono" style="display:none; margin-top:10px; word-break:break-all;"></div>
        </div>

        <!-- === Refinement 2: more breathing room above report header === -->
        <div id="reportArea" style="margin-top:16px;">
          <div class="section-title">
            <h2>Chest pain report</h2>
            <div class="small">Generated: <span id="reportGeneratedAt">—</span></div>
          </div>

          <div class="subcard">
            <h3>Summary</h3>
            <div id="reportSummary" class="muted"></div>
          </div>

          <div class="subcard">
            <h3>Episodes</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>Date/Time</th><th>Severity</th><th>Duration</th><th>Activity</th>
                  <th>Type/Location</th><th>Symptoms</th><th>Relief</th><th>Notes</th>
                </tr>
              </thead>
              <tbody id="reportTbody"></tbody>
            </table>
            <div id="reportCards" class="report-cards"></div>
          </div>

          <div class="subcard no-print">
            <h3>Advanced</h3>
            <div class="row" style="margin-top:10px;">
              <button id="exportAllJsonBtn">Download ALL data (JSON)</button>
              <button id="exportAllCsvBtn">Download ALL data (CSV)</button>
              <button id="clearAllBtn" class="danger">Clear ALL data (device + Firebase)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SHARE VIEW -->
    <div id="viewShare" class="view">
      <div class="card">
        <div class="section-title">
          <h2>Shared chest pain report</h2>
          <div class="small">Read-only</div>
        </div>

        <div class="subcard no-print">
          <div class="row">
            <button class="primary" id="sharePrintBtn">Print / Save PDF</button>
            <button id="shareDownloadCsvBtn">Download CSV</button>
            <button id="shareDownloadJsonBtn">Download JSON</button>
          </div>
        </div>

        <div class="section-title">
          <h2>Report</h2>
          <div class="small">Generated: <span id="shareGeneratedAt">—</span></div>
        </div>

        <div class="subcard">
          <h3>Summary</h3>
          <div id="shareSummary" class="muted"></div>
        </div>

        <div class="subcard">
          <h3>Episodes</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Date/Time</th><th>Severity</th><th>Duration</th><th>Activity</th>
                <th>Type/Location</th><th>Symptoms</th><th>Relief</th><th>Notes</th>
              </tr>
            </thead>
            <tbody id="shareTbody"></tbody>
          </table>
          <div id="shareCards" class="report-cards"></div>

          <div id="shareError" class="banner" style="display:none; border-color: rgba(255,107,107,.4); background: rgba(255,107,107,.10);">
            <b>Could not load shared report</b>
            <div class="small">The link may be invalid or revoked.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile bottom tab bar: Home -> Log -> History -> Export -->
  <div class="tabbar no-print" id="tabbar">
    <div class="tabbar-inner">
      <button class="tabbtn" id="tabHome">Home</button>
      <button class="tabbtn log" id="tabLog">Log</button>
      <button class="tabbtn" id="tabHistory">History</button>
      <button class="tabbtn" id="tabExport">Export</button>
    </div>
  </div>

  <!-- Log sheet modal -->
  <div class="modal-backdrop no-print" id="logModal">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Log chest pain">
      <div class="sheet-header">
        <div>
          <b id="sheetTitle">Log an episode</b>
          <div class="sub" id="sheetSub">Draft saves automatically while you type.</div>
        </div>
        <div class="sheet-actions">
          <button id="closeSheet" class="ghost">Close</button>
          <button id="discardDraftBtnHeader" class="danger">Discard</button>
        </div>
      </div>

      <div class="form">
        <div>
          <label>Start time</label>
          <input id="startAt" type="datetime-local" />
          <div class="help">Defaults to now.</div>
        </div>

        <div>
          <label>Ongoing?</label>
          <select id="ongoing">
            <option value="true">Yes (still happening)</option>
            <option value="false">No (ended)</option>
          </select>
          <div id="endAtWrap" style="display:none; margin-top:10px;">
            <label>End time</label>
            <input id="endAt" type="datetime-local" />
            <div class="help">Or choose duration:</div>
            <div id="durationChips" class="chips"></div>
          </div>
        </div>

        <div>
          <label>Severity (0–10)</label>
          <input id="severity" type="range" min="0" max="10" step="1" />
          <div class="help">Selected: <b id="severityVal">5</b></div>
        </div>

        <div>
          <label>Pain type</label>
          <div id="painTypeChips" class="chips"></div>

          <!-- NEW: helper box for classification -->
          <div id="painTypeHelpBox" class="subcard" style="margin-top:10px;">
            <h3 style="margin-bottom:6px;">Pain type guide</h3>
            <div class="muted" id="painTypeHelpText" style="font-size:12px; line-height:1.35;">
              Tap a pain type to see a quick guide.
            </div>
          </div>

          <div id="painTypeOtherWrap" style="display:none; margin-top:10px;">
            <label>Describe “Other”</label>
            <input id="painTypeOtherText" type="text" maxlength="80" placeholder="e.g., stabbing, prickly, etc." />
            <div class="help"><span id="painTypeOtherCount">0</span>/80</div>
          </div>
        </div>

        <div>
          <label>Location</label>
          <div id="locationChips" class="chips"></div>
        </div>

        <div>
          <label>Activity at onset</label>
          <div id="activityChips" class="chips"></div>
        </div>

        <div>
          <label>Relief</label>
          <div id="reliefChips" class="chips"></div>
        </div>

        <div>
          <label>Associated symptoms</label>
          <div id="symptomChips" class="chips"></div>
          <div class="help">Tip: choose “None” if there were no other symptoms.</div>
        </div>

        <div style="grid-column: 1 / -1;">
          <label>Notes (optional)</label>
          <textarea id="notes" maxlength="500" placeholder=""></textarea>
          <div class="help"><span id="notesCount">0</span>/500</div>
        </div>

        <div style="grid-column: 1 / -1;" class="no-print">
          <button id="saveSheetInline" class="primary" style="width:100%; padding:16px 16px; font-size:16px; border-radius:16px;">
            Save log
          </button>
        </div>

        <div style="grid-column: 1 / -1;">
          <div class="subcard">
            <h3>Optional vitals</h3>
            <div class="form" style="padding:0; padding-bottom:0;">
              <div><label>Heart rate (bpm)</label><input id="v_hr" type="number" inputmode="numeric" placeholder="e.g. 92" /></div>
              <div><label>SpO₂ (%)</label><input id="v_spo2" type="number" inputmode="numeric" placeholder="e.g. 98" /></div>
              <div><label>BP systolic</label><input id="v_bpsys" type="number" inputmode="numeric" placeholder="e.g. 130" /></div>
              <div><label>BP diastolic</label><input id="v_bpdia" type="number" inputmode="numeric" placeholder="e.g. 80" /></div>
            </div>
          </div>
        </div>
      </div>

      <div class="sheet-footer">
        <div class="footer-left">
          <button id="discardDraftBtnFooter" class="danger">Discard</button>
          <button id="closeSheetFooter" class="ghost">Close</button>
        </div>
        <div class="footer-right">
          <button id="saveSheet" class="primary">Save log</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, deleteDoc,
    collection, query, orderBy, limit, getDocs, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAY9or2wznVWfjmcA7t8zmvP4tij4GV0Vc",
    authDomain: "chest-pain-tracker.firebaseapp.com",
    projectId: "chest-pain-tracker",
    storageBucket: "chest-pain-tracker.firebasestorage.app",
    messagingSenderId: "695419264328",
    appId: "1:695419264328:web:279b5091674d4497c1a77d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  const PAIN_TYPE_HELP = {
    "Pressure": "Feels like heaviness, squeezing, or a weight on the chest. Often described as “tight band” or “elephant sitting on chest.”",
    "Tightness": "A constricted feeling, like the chest is being held or compressed. May come with shortness of breath.",
    "Sharp": "Sudden, stabbing, or needle-like pain. Often localized and may worsen with deep breaths or movement.",
    "Burning": "Hot, acid-like, or “heartburn” sensation. Can relate to reflux, but still log it for patterns.",
    "Ache": "Dull, sore, or lingering discomfort. Less sudden than sharp pain and may feel like muscle soreness.",
    "Other": "Use when none of the above fit. Describe the sensation in your own words."
  };

  const ENUMS = {
    painType: ["Pressure","Tightness","Sharp","Burning","Ache","Other"],
    location: ["Center","Left","Right","Upper abdomen","Other"],
    activity: ["Rest","Walking","Stairs","Exercise","After meal","Stress","Sleeping","Other"],
    relief: ["Rest","Breathing","Antacid","Nitro","Painkiller","None","Other"],
    symptoms: ["Shortness of breath","Sweating","Nausea","Dizziness","Palpitations","Radiation (arm/jaw/back)","None"],
    durationMins: [1,5,10,20,30,60,120]
  };

  const IDB_NAME = "cpt_db_v4";
  const IDB_VER = 1;

  let UID = null;
  let EPISODES = [];
  let DRAFT = null;
  let EDITING_ID = null;
  let SHARE_TOKEN = null;

  let draftTimer = null;
  let editSyncTimer = null;
  let lastWriteError = null;
  let unsubMeta = null;

  function setSync(status){
    const pill = $("syncPill");
    const text = $("syncText");
    pill.classList.remove("good","warn","bad");
    let cls = "warn";
    if(status === "Synced") cls = "good";
    if(status.startsWith("Sync error")) cls = "bad";
    pill.classList.add(cls);
    text.textContent = status;
  }

  function setView(name){
    ["Home","History","Export","Share"].forEach(v=>{
      const el = $("view"+v);
      if(el) el.classList.toggle("active", v.toLowerCase() === name.toLowerCase());
    });
    $("tabHome")?.classList.toggle("active", name==="Home");
    $("tabHistory")?.classList.toggle("active", name==="History");
    $("tabExport")?.classList.toggle("active", name==="Export");
  }

  function showModal(){
    $("logModal").classList.add("show");
    document.body.style.overflow = "hidden";
  }
  function hideModal(){
    $("logModal").classList.remove("show");
    document.body.style.overflow = "";
  }

  function nowLocal(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function toDTLocal(d){
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function parseDTLocal(val){
    if(!val) return null;
    const d = new Date(val);
    return isNaN(d.getTime()) ? null : d;
  }
  function fmtDateTime(d){
    const dt = (d instanceof Date) ? d : new Date(d);
    if(isNaN(dt.getTime())) return "—";
    return dt.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  }
  function minutesBetween(a,b){
    if(!a || !b) return null;
    return Math.max(0, Math.round((b.getTime()-a.getTime())/60000));
  }
  function durationLabel(startAt, endAt, ongoing){
    if(ongoing) return "Ongoing";
    const a = startAt ? new Date(startAt) : null;
    const b = endAt ? new Date(endAt) : null;
    const mins = minutesBetween(a,b);
    if(mins == null) return "—";
    if(mins < 60) return `${mins} min`;
    const h = Math.floor(mins/60), m = mins%60;
    return m ? `${h}h ${m}m` : `${h}h`;
  }
  function safeArray(a){ return Array.isArray(a) ? a : []; }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function idbOpen(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open(IDB_NAME, IDB_VER);
      req.onupgradeneeded = () => {
        const d = req.result;
        if(!d.objectStoreNames.contains("episodes")){
          d.createObjectStore("episodes", { keyPath:"id" });
        }
        if(!d.objectStoreNames.contains("meta")){
          d.createObjectStore("meta", { keyPath:"key" });
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }
  async function idbGet(store, key){
    const dbi = await idbOpen();
    return new Promise((resolve,reject)=>{
      const tx = dbi.transaction(store,"readonly");
      const req = tx.objectStore(store).get(key);
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }
  async function idbPut(store, val){
    const dbi = await idbOpen();
    return new Promise((resolve,reject)=>{
      const tx = dbi.transaction(store,"readwrite");
      tx.objectStore(store).put(val);
      tx.oncomplete = ()=> resolve(true);
      tx.onerror = ()=> reject(tx.error);
    });
  }
  async function idbDelete(store, key){
    const dbi = await idbOpen();
    return new Promise((resolve,reject)=>{
      const tx = dbi.transaction(store,"readwrite");
      tx.objectStore(store).delete(key);
      tx.oncomplete = ()=> resolve(true);
      tx.onerror = ()=> reject(tx.error);
    });
  }
  async function idbGetAllEpisodes(){
    const dbi = await idbOpen();
    return new Promise((resolve,reject)=>{
      const tx = dbi.transaction("episodes","readonly");
      const req = tx.objectStore("episodes").getAll();
      req.onsuccess = ()=> resolve(req.result || []);
      req.onerror = ()=> reject(req.error);
    });
  }

  function buildDefaultDraft(){
    return {
      startAt: new Date().toISOString(),
      ongoing: true,
      endAt: null,
      severity: 5,
      painType: "Pressure",
      painTypeOtherText: "",
      location: "Center",
      onsetActivity: "Rest",
      relief: [],
      symptoms: [],
      notes: "",
      vitals: { hr:null, spo2:null, bpSys:null, bpDia:null }
    };
  }

  function summarizeDraft(d){
    const when = d?.startAt ? fmtDateTime(new Date(d.startAt)) : "—";
    const pain = d?.painType === "Other" && d?.painTypeOtherText ? `Other: ${d.painTypeOtherText}` : (d?.painType ?? "—");
    return `${when} • ${d?.severity ?? 5}/10 • ${pain} • ${d?.location ?? "—"} • ${d?.onsetActivity ?? "—"}`;
  }

  function numOrNull(v){
    if(v === "" || v == null) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function newId(){ return crypto.randomUUID(); }

  function updateChipSelection(container, value, isMulti){
    [...container.children].forEach(el=>{
      const selected = isMulti ? safeArray(value).includes(el.textContent) : (value === el.textContent);
      el.classList.toggle("selected", selected);
    });
  }

  function setPainTypeHelp(painType){
    const t = $("painTypeHelpText");
    const msg = PAIN_TYPE_HELP[painType] || "Tap a pain type to see a quick guide.";
    t.textContent = msg;
  }

  function renderSingleChips(containerId, options, getter, setter, onAfter){
    const el = $(containerId);
    el.innerHTML = "";
    options.forEach(opt=>{
      const c = document.createElement("div");
      c.className = "chip";
      c.textContent = opt;
      c.onclick = ()=>{
        setter(opt);
        updateChipSelection(el, getter(), false);
        if(typeof onAfter === "function") onAfter(opt);
        onFormChange();
      };
      el.appendChild(c);
    });
    updateChipSelection(el, getter(), false);
  }

  function renderMultiChips(containerId, options, getter, setter){
    const el = $(containerId);
    el.innerHTML = "";
    options.forEach(opt=>{
      const c = document.createElement("div");
      c.className = "chip";
      c.textContent = opt;
      c.onclick = ()=>{
        const set = new Set(getter());
        if(opt === "None"){
          if(set.has("None")) set.delete("None"); else { set.clear(); set.add("None"); }
        } else {
          set.delete("None");
          if(set.has(opt)) set.delete(opt); else set.add(opt);
        }
        setter([...set]);
        updateChipSelection(el, getter(), true);
        onFormChange();
      };
      el.appendChild(c);
    });
    updateChipSelection(el, getter(), true);
  }

  function renderDurationChips(){
    const el = $("durationChips");
    el.innerHTML = "";
    ENUMS.durationMins.forEach(mins=>{
      const c = document.createElement("div");
      c.className = "chip";
      c.textContent = mins >= 120 ? "120+ min" : `${mins} min`;
      c.onclick = ()=>{
        const start = parseDTLocal($("startAt").value);
        if(!start) return;
        $("endAt").value = toDTLocal(new Date(start.getTime() + mins*60000));
        onFormChange();
      };
      el.appendChild(c);
    });
  }

  function syncPainTypeOtherUI(){
    const show = (DRAFT?.painType === "Other");
    $("painTypeOtherWrap").style.display = show ? "block" : "none";
    if(!show){
      $("painTypeOtherText").value = "";
      $("painTypeOtherCount").textContent = "0";
      if(DRAFT) DRAFT.painTypeOtherText = "";
    } else {
      $("painTypeOtherText").value = DRAFT?.painTypeOtherText || "";
      $("painTypeOtherCount").textContent = String(($("painTypeOtherText").value||"").length);
    }
    // Update helper always
    setPainTypeHelp(DRAFT?.painType || "Pressure");
  }

  function initChips(){
    if(!DRAFT) DRAFT = buildDefaultDraft();
    renderSingleChips("painTypeChips", ENUMS.painType, ()=>DRAFT.painType, (v)=>{ DRAFT.painType=v; }, ()=>{
      syncPainTypeOtherUI();
    });
    renderSingleChips("locationChips", ENUMS.location, ()=>DRAFT.location, (v)=>{ DRAFT.location=v; });
    renderSingleChips("activityChips", ENUMS.activity, ()=>DRAFT.onsetActivity, (v)=>{ DRAFT.onsetActivity=v; });
    renderMultiChips("reliefChips", ENUMS.relief, ()=>safeArray(DRAFT.relief), (arr)=>{ DRAFT.relief=arr; });
    renderMultiChips("symptomChips", ENUMS.symptoms, ()=>safeArray(DRAFT.symptoms), (arr)=>{ DRAFT.symptoms=arr; });
    renderDurationChips();
    syncPainTypeOtherUI();
  }

  function applyForm(d){
    $("startAt").value = d?.startAt ? toDTLocal(new Date(d.startAt)) : nowLocal();
    $("ongoing").value = (d?.ongoing ?? true) ? "true" : "false";
    $("severity").value = String(d?.severity ?? 5);
    $("severityVal").textContent = String(d?.severity ?? 5);

    $("notes").value = d?.notes ?? "";
    $("notesCount").textContent = String(($("notes").value||"").length);

    const ended = $("ongoing").value === "false";
    $("endAtWrap").style.display = ended ? "block" : "none";
    $("endAt").value = (ended && d?.endAt) ? toDTLocal(new Date(d.endAt)) : "";

    $("v_hr").value = d?.vitals?.hr ?? "";
    $("v_spo2").value = d?.vitals?.spo2 ?? "";
    $("v_bpsys").value = d?.vitals?.bpSys ?? "";
    $("v_bpdia").value = d?.vitals?.bpDia ?? "";

    updateChipSelection($("painTypeChips"), d?.painType ?? DRAFT.painType, false);
    updateChipSelection($("locationChips"), d?.location ?? DRAFT.location, false);
    updateChipSelection($("activityChips"), d?.onsetActivity ?? DRAFT.onsetActivity, false);
    updateChipSelection($("reliefChips"), safeArray(d?.relief ?? DRAFT.relief), true);
    updateChipSelection($("symptomChips"), safeArray(d?.symptoms ?? DRAFT.symptoms), true);

    syncPainTypeOtherUI();
  }

  function getFormState(){
    const start = parseDTLocal($("startAt").value);
    const ongoing = $("ongoing").value === "true";
    const end = ongoing ? null : parseDTLocal($("endAt").value);

    const vitals = {
      hr: numOrNull($("v_hr").value),
      spo2: numOrNull($("v_spo2").value),
      bpSys: numOrNull($("v_bpsys").value),
      bpDia: numOrNull($("v_bpdia").value)
    };
    const vitalsNonEmpty = Object.values(vitals).some(v=>v!==null) ? vitals : null;

    return {
      startAt: start ? start.toISOString() : null,
      ongoing,
      endAt: end ? end.toISOString() : null,
      severity: Number($("severity").value),
      notes: ($("notes").value || "").trim(),
      painTypeOtherText: ($("painTypeOtherText").value || "").trim(),
      vitals: vitalsNonEmpty
    };
  }

  async function onFormChange(){
    if(!DRAFT) return;

    const s = getFormState();
    DRAFT = {
      ...DRAFT,
      ...s,
      relief: safeArray(DRAFT.relief),
      symptoms: safeArray(DRAFT.symptoms),
      updatedAtLocal: new Date().toISOString()
    };

    if(DRAFT.painType !== "Other"){
      DRAFT.painTypeOtherText = "";
    }

    if(draftTimer) clearTimeout(draftTimer);
    draftTimer = setTimeout(async ()=>{
      await idbPut("meta", { key: "draft", value: DRAFT });
      setSync(navigator.onLine ? "Saved locally" : "Offline (saved locally)");
      renderDraftResume();

      if(EDITING_ID){
        await mirrorDraftToEpisode();
      }
    }, 280);
  }

  async function loadMeta(){
    const d = await idbGet("meta", "draft");
    DRAFT = d?.value || null;

    const s = await idbGet("meta", "share_token");
    SHARE_TOKEN = s?.value || null;
  }

  async function loadLocalEpisodes(){
    EPISODES = await idbGetAllEpisodes();
    EPISODES.sort((a,b)=> (b.startAt||"").localeCompare(a.startAt||""));
  }

  function renderDraftResume(){
    const box = $("resumeDraftBox");
    if(DRAFT && !EDITING_ID){
      box.style.display = "block";
      $("draftSummary").textContent = summarizeDraft(DRAFT);
    } else {
      box.style.display = "none";
    }
  }

  function renderKPIs(){
    const now = new Date();
    const daysAgo = (n)=> new Date(now.getTime() - n*86400000).toISOString();
    const inRange = (isoStart, days)=> days==="all" ? true : (isoStart && isoStart >= daysAgo(Number(days)));

    $("kpi7d").textContent = String(EPISODES.filter(e=>inRange(e.startAt,7)).length);
    $("kpi30d").textContent = String(EPISODES.filter(e=>inRange(e.startAt,30)).length);
    $("kpiLast").textContent = EPISODES[0] ? `${EPISODES[0].severity}/10` : "—";

    const map = new Map();
    EPISODES.filter(e=>inRange(e.startAt,30)).forEach(e=>{
      const k = e.onsetActivity || "—";
      map.set(k, (map.get(k)||0)+1);
    });
    let best="—", bestN=0;
    for(const [k,v] of map.entries()){ if(v>bestN){best=k;bestN=v;} }
    $("kpiCommonActivity").textContent = bestN ? `${best} (${bestN})` : "—";
  }

  function renderHistory(){
    const list = $("historyList");
    list.innerHTML = "";
    const range = $("historyRange").value;
    const sev = $("historySeverity").value;

    const now = new Date();
    const minIso = (range==="all") ? null : new Date(now.getTime() - Number(range)*86400000).toISOString();

    let items = EPISODES.slice();
    if(minIso) items = items.filter(e => (e.startAt||"") >= minIso);

    if(sev !== "all"){
      if(sev === "7+") items = items.filter(e => (e.severity ?? 0) >= 7);
      if(sev === "4+") items = items.filter(e => (e.severity ?? 0) >= 4);
      if(sev === "0-3") items = items.filter(e => (e.severity ?? 0) <= 3);
    }

    if(!items.length){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No episodes in this range.";
      list.appendChild(empty);
      return;
    }

    items.forEach(e=>{
      const item = document.createElement("div");
      item.className = "item";
      item.onclick = ()=> openEditEpisode(e.id);

      const left = document.createElement("div");
      const main = document.createElement("b");
      main.textContent = `${fmtDateTime(new Date(e.startAt))} • ${e.severity}/10 • ${durationLabel(e.startAt, e.endAt, e.ongoing)}`;
      const sub = document.createElement("span");
      const pain = (e.painType === "Other" && e.painTypeOtherText) ? `Other: ${e.painTypeOtherText}` : (e.painType || "—");
      sub.textContent = `${pain} • ${e.location || "—"} • ${e.onsetActivity || "—"}`;
      left.appendChild(main); left.appendChild(sub);

      const right = document.createElement("div");
      right.className = "right";
      const s1 = document.createElement("span");
      const sym = safeArray(e.symptoms).filter(x=>x && x!=="None");
      s1.textContent = sym.length ? sym.slice(0,2).join(", ") + (sym.length>2 ? "…" : "") : "No symptoms";
      right.appendChild(s1);

      item.appendChild(left); item.appendChild(right);
      list.appendChild(item);
    });
  }

  function computeReportRows(range){
    const now = new Date();
    const minIso = (range==="all") ? null : new Date(now.getTime() - Number(range)*86400000).toISOString();
    let items = EPISODES.slice();
    if(minIso) items = items.filter(e => (e.startAt||"") >= minIso);
    items.sort((a,b)=> (a.startAt||"").localeCompare(b.startAt||""));

    return items.map(e=>{
      const dt = e.startAt ? new Date(e.startAt) : null;
      const pain = (e.painType === "Other" && e.painTypeOtherText) ? `Other: ${e.painTypeOtherText}` : (e.painType || "");
      return {
        dateTimeLabel: dt ? fmtDateTime(dt) : "",
        severity: e.severity ?? "",
        duration: durationLabel(e.startAt, e.endAt, e.ongoing),
        activity: e.onsetActivity || "",
        typeLocation: `${pain}${e.location ? " • " + e.location : ""}`.trim(),
        symptoms: safeArray(e.symptoms).join(", "),
        relief: safeArray(e.relief).join(", "),
        notes: (e.notes || "").trim()
      };
    });
  }

  function computeReportSummary(rows){
    const count = rows.length;
    if(!count) return "No episodes in the selected range.";
    const sev = rows.map(r=>Number(r.severity)).filter(n=>Number.isFinite(n));
    const avg = sev.length ? (sev.reduce((a,b)=>a+b,0)/sev.length) : null;
    const max = sev.length ? Math.max(...sev) : null;

    const actMap = new Map();
    rows.forEach(r=>{
      const k = r.activity || "—";
      actMap.set(k, (actMap.get(k)||0)+1);
    });
    let bestAct="—", bestN=0;
    for(const [k,v] of actMap.entries()){ if(v>bestN){bestAct=k;bestN=v;} }

    const parts = [];
    parts.push(`Total episodes: ${count}.`);
    if(avg != null) parts.push(`Average severity: ${avg.toFixed(1)}/10 (max ${max}/10).`);
    if(bestN) parts.push(`Most common onset activity: ${bestAct} (${bestN}).`);
    return parts.join(" ");
  }

  function renderReport(){
    const range = $("exportRange").value;
    const rows = computeReportRows(range);
    $("reportGeneratedAt").textContent = new Date().toLocaleString();
    $("reportSummary").textContent = computeReportSummary(rows);

    const tbody = $("reportTbody");
    tbody.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.dateTimeLabel)}</td>
        <td>${escapeHtml(String(r.severity))}</td>
        <td>${escapeHtml(r.duration)}</td>
        <td>${escapeHtml(r.activity)}</td>
        <td>${escapeHtml(r.typeLocation)}</td>
        <td>${escapeHtml(r.symptoms)}</td>
        <td>${escapeHtml(r.relief)}</td>
        <td>${escapeHtml(r.notes)}</td>
      `;
      tbody.appendChild(tr);
    });

    const cards = $("reportCards");
    cards.innerHTML = "";
    rows.forEach(r=>{
      const card = document.createElement("div");
      card.className = "report-card";
      card.innerHTML = `
        <div class="report-kv">
          <div>Date/Time</div><div>${escapeHtml(r.dateTimeLabel)}</div>
          <div>Severity</div><div>${escapeHtml(String(r.severity))}</div>
          <div>Duration</div><div>${escapeHtml(r.duration)}</div>
          <div>Activity</div><div>${escapeHtml(r.activity)}</div>
          <div>Type/Location</div><div>${escapeHtml(r.typeLocation)}</div>
          <div>Symptoms</div><div>${escapeHtml(r.symptoms)}</div>
          <div>Relief</div><div>${escapeHtml(r.relief)}</div>
          <div>Notes</div><div>${escapeHtml(r.notes)}</div>
        </div>
      `;
      cards.appendChild(card);
    });

    updateShareUI();
  }

  function renderAll(){
    renderDraftResume();
    renderKPIs();
    renderHistory();
    renderReport();
  }

  async function upsertEpisodeRemote(ep){
    if(!UID) return;
    if(!navigator.onLine){
      setSync("Offline (saved locally)");
      return;
    }
    try{
      const ref = doc(db, "users", UID, "episodes", ep.id);
      await setDoc(ref, {
        ...ep,
        ownerUid: UID,
        updatedAt: serverTimestamp(),
        createdAt: ep.createdAt ? new Date(ep.createdAt) : serverTimestamp()
      }, { merge:true });
      lastWriteError = null;
    }catch(e){
      console.error("Remote upsert failed:", e);
      lastWriteError = e;
      setSync("Sync error (saved locally)");
    }
  }

  async function mirrorDraftToEpisode(){
    const ep = EPISODES.find(e=>e.id===EDITING_ID);
    if(!ep) return;

    const updated = {
      ...ep,
      startAt: DRAFT.startAt,
      endAt: DRAFT.endAt,
      ongoing: DRAFT.ongoing,
      severity: DRAFT.severity,
      painType: DRAFT.painType,
      painTypeOtherText: DRAFT.painTypeOtherText || "",
      location: DRAFT.location,
      onsetActivity: DRAFT.onsetActivity,
      relief: safeArray(DRAFT.relief),
      symptoms: safeArray(DRAFT.symptoms),
      notes: DRAFT.notes || "",
      vitals: DRAFT.vitals,
      updatedAt: new Date().toISOString(),
      createdAt: ep.createdAt || new Date().toISOString()
    };

    await idbPut("episodes", updated);
    EPISODES = EPISODES.map(x => x.id===updated.id ? updated : x);
    renderAll();

    if(editSyncTimer) clearTimeout(editSyncTimer);
    editSyncTimer = setTimeout(async ()=>{
      await upsertEpisodeRemote(updated);
    }, 850);
  }

  async function clearDraftOnly(){
    DRAFT = null;
    EDITING_ID = null;
    await idbDelete("meta", "draft");
    renderDraftResume();
  }

  async function discardDraft(){
    await clearDraftOnly();
    hideModal();
  }

  async function saveLog(){
    if(!DRAFT) return;

    if(!DRAFT.startAt){
      alert("Please set a start time.");
      return;
    }
    if(DRAFT.painType === "Other" && !(DRAFT.painTypeOtherText || "").trim()){
      alert("Please describe the pain type (Other).");
      return;
    }

    if(EDITING_ID){
      await mirrorDraftToEpisode();
      const ep = EPISODES.find(e=>e.id===EDITING_ID);
      if(ep) await upsertEpisodeRemote(ep);
      await clearDraftOnly();
      hideModal();
      setView("History");
      return;
    }

    const episode = {
      id: crypto.randomUUID(),
      startAt: DRAFT.startAt,
      endAt: DRAFT.endAt,
      ongoing: DRAFT.ongoing,
      severity: DRAFT.severity,
      painType: DRAFT.painType,
      painTypeOtherText: DRAFT.painTypeOtherText || "",
      location: DRAFT.location,
      onsetActivity: DRAFT.onsetActivity,
      relief: safeArray(DRAFT.relief),
      symptoms: safeArray(DRAFT.symptoms),
      notes: DRAFT.notes || "",
      vitals: DRAFT.vitals,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    await idbPut("episodes", episode);
    setSync(navigator.onLine ? "Saved locally" : "Offline (saved locally)");
    await clearDraftOnly();
    await loadLocalEpisodes();
    renderAll();

    await upsertEpisodeRemote(episode);

    hideModal();
    setView("History");
  }

  async function startNewDraftAndOpen(){
    EDITING_ID = null;
    DRAFT = buildDefaultDraft();
    await idbPut("meta", { key: "draft", value: DRAFT });
    $("sheetTitle").textContent = "Log an episode";
    $("sheetSub").textContent = "Draft saves automatically while you type.";
    applyForm(DRAFT);
    showModal();
  }

  async function openEditEpisode(id){
    const ep = EPISODES.find(e=>e.id===id);
    if(!ep) return;
    EDITING_ID = id;
    DRAFT = {
      ...buildDefaultDraft(),
      ...ep,
      relief: safeArray(ep.relief),
      symptoms: safeArray(ep.symptoms),
      painTypeOtherText: ep.painTypeOtherText || ""
    };
    await idbPut("meta", { key: "draft", value: DRAFT });
    $("sheetTitle").textContent = "Edit episode";
    $("sheetSub").textContent = "Draft saves automatically. Save to apply.";
    applyForm(DRAFT);
    showModal();
  }

  function buildShareLink(token){
    const base = location.origin + location.pathname;
    return `${base}#share=${encodeURIComponent(token)}`;
  }

  function updateShareUI(){
    const has = !!SHARE_TOKEN;
    $("copyShareBtn").style.display = has ? "inline-block" : "none";
    $("revokeShareBtn").style.display = has ? "inline-block" : "none";
    $("shareLinkBox").style.display = has ? "block" : "none";
    if(has) $("shareLinkBox").textContent = buildShareLink(SHARE_TOKEN);
  }

  async function revokeShareLink(){
    if(!SHARE_TOKEN) return;
    try{
      if(navigator.onLine) await deleteDoc(doc(db, "sharedReports", SHARE_TOKEN));
    }catch(e){
      console.warn("Revoke share link failed:", e);
    }
    SHARE_TOKEN = null;
    await idbDelete("meta", "share_token");
    updateShareUI();
  }

  async function createOrReplaceShareLink(){
    if(!UID){
      alert("Still starting up, try again in a moment.");
      return;
    }
    if(!navigator.onLine){
      alert("You appear offline. Connect to the internet to create the share link.");
      return;
    }

    if(SHARE_TOKEN) await revokeShareLink();

    const range = $("exportRange").value;
    const rows = computeReportRows(range);
    const summary = computeReportSummary(rows);

    const token = crypto.randomUUID().replaceAll("-","") + crypto.randomUUID().replaceAll("-","");
    try{
      await setDoc(doc(db, "sharedReports", token), {
        ownerUid: UID,
        generatedAt: new Date().toISOString(),
        range,
        summary,
        rows
      }, { merge:false });

      SHARE_TOKEN = token;
      await idbPut("meta", { key: "share_token", value: SHARE_TOKEN });
      updateShareUI();
      setSync("Synced");
    }catch(e){
      console.error("Create share link failed:", e);
      setSync("Sync error (saved locally)");
      alert("Could not create share link. Please try again.");
    }
  }

  async function copyShareLink(){
    if(!SHARE_TOKEN) return;
    const link = buildShareLink(SHARE_TOKEN);
    try{
      await navigator.clipboard.writeText(link);
      alert("Share link copied.");
    }catch{
      prompt("Copy this link:", link);
    }
  }

  function downloadBlob(content, filename, mime){
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function downloadJSON(obj, filename){
    downloadBlob(JSON.stringify(obj, null, 2), filename, "application/json");
  }
  function downloadCSV(rows, filename){
    const cols = ["dateTimeLabel","severity","duration","activity","typeLocation","symptoms","relief","notes"];
    const esc = (v)=>{
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    };
    const header = cols.join(",");
    const lines = rows.map(r => cols.map(c => esc(r[c])).join(","));
    downloadBlob([header, ...lines].join("\n"), filename, "text/csv;charset=utf-8");
  }

  async function clearAllData(){
    if(!confirm("This will delete ALL episodes locally and in Firebase for this device. Continue?")) return;

    try{
      const dbi = await idbOpen();
      await new Promise((resolve,reject)=>{
        const tx = dbi.transaction(["episodes","meta"], "readwrite");
        tx.objectStore("episodes").clear();
        tx.objectStore("meta").clear();
        tx.oncomplete = ()=> resolve(true);
        tx.onerror = ()=> reject(tx.error);
      });
    }catch(e){
      console.warn("Local clear failed", e);
    }

    if(UID && navigator.onLine){
      try{
        if(SHARE_TOKEN) await deleteDoc(doc(db, "sharedReports", SHARE_TOKEN));
        const snaps = await getDocs(collection(db, "users", UID, "episodes"));
        for(const d of snaps.docs) await deleteDoc(d.ref);
      }catch(e){
        console.warn("Remote clear failed", e);
      }
    }

    EPISODES = [];
    DRAFT = null;
    EDITING_ID = null;
    SHARE_TOKEN = null;
    setSync("Synced");
    renderAll();
    setView("Home");
    alert("All data cleared.");
  }

  async function loadSharedReport(token){
    try{
      const snap = await getDoc(doc(db, "sharedReports", token));
      if(!snap.exists()){
        $("shareError").style.display = "block";
        return;
      }
      $("shareError").style.display = "none";
      const data = snap.data();
      $("shareGeneratedAt").textContent = data.generatedAt ? new Date(data.generatedAt).toLocaleString() : "—";
      $("shareSummary").textContent = data.summary || "";

      const rows = safeArray(data.rows);

      const tbody = $("shareTbody");
      tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.dateTimeLabel || "")}</td>
          <td>${escapeHtml(String(r.severity ?? ""))}</td>
          <td>${escapeHtml(r.duration || "")}</td>
          <td>${escapeHtml(r.activity || "")}</td>
          <td>${escapeHtml(r.typeLocation || "")}</td>
          <td>${escapeHtml(r.symptoms || "")}</td>
          <td>${escapeHtml(r.relief || "")}</td>
          <td>${escapeHtml(r.notes || "")}</td>
        `;
        tbody.appendChild(tr);
      });

      const cards = $("shareCards");
      cards.innerHTML = "";
      rows.forEach(r=>{
        const card = document.createElement("div");
        card.className = "report-card";
        card.innerHTML = `
          <div class="report-kv">
            <div>Date/Time</div><div>${escapeHtml(r.dateTimeLabel || "")}</div>
            <div>Severity</div><div>${escapeHtml(String(r.severity ?? ""))}</div>
            <div>Duration</div><div>${escapeHtml(r.duration || "")}</div>
            <div>Activity</div><div>${escapeHtml(r.activity || "")}</div>
            <div>Type/Location</div><div>${escapeHtml(r.typeLocation || "")}</div>
            <div>Symptoms</div><div>${escapeHtml(r.symptoms || "")}</div>
            <div>Relief</div><div>${escapeHtml(r.relief || "")}</div>
            <div>Notes</div><div>${escapeHtml(r.notes || "")}</div>
          </div>
        `;
        cards.appendChild(card);
      });

      $("shareDownloadJsonBtn").onclick = ()=> downloadJSON(rows, "shared_report_rows.json");
      $("shareDownloadCsvBtn").onclick = ()=> downloadCSV(rows, "shared_report_rows.csv");
    }catch(e){
      console.error("Load shared report failed:", e);
      $("shareError").style.display = "block";
    }
  }

  async function enterShareModeIfHash(){
    const h = location.hash || "";
    const m = h.match(/share=([^&]+)/);
    if(!m) return false;
    const token = decodeURIComponent(m[1] || "").trim();
    if(!token) return false;

    $("tabbar").style.display = "none";
    setView("Share");
    $("syncPill").style.display = "none";
    await loadSharedReport(token);
    return true;
  }

  function startMetadataSyncListener(){
    if(!UID) return;
    if(unsubMeta) unsubMeta();

    const q = query(
      collection(db, "users", UID, "episodes"),
      orderBy("startAt", "desc"),
      limit(50)
    );

    unsubMeta = onSnapshot(q, { includeMetadataChanges:true }, (snap)=>{
      if(!navigator.onLine){
        setSync("Offline (saved locally)");
        return;
      }
      if(snap.metadata.hasPendingWrites){
        setSync("Syncing…");
      } else {
        setSync(lastWriteError ? "Sync error (saved locally)" : "Synced");
      }
    }, (err)=>{
      console.warn("Listener error:", err);
      setSync("Sync error (saved locally)");
    });
  }

  function wireEvents(){
    $("navHome").onclick = ()=> setView("Home");
    $("navLog").onclick = ()=> (DRAFT ? (applyForm(DRAFT), showModal()) : startNewDraftAndOpen());
    $("navHistory").onclick = ()=> setView("History");
    $("navExport").onclick = ()=> setView("Export");

    $("tabHome").onclick = ()=> setView("Home");
    $("tabLog").onclick = ()=> (DRAFT ? (applyForm(DRAFT), showModal()) : startNewDraftAndOpen());
    $("tabHistory").onclick = ()=> setView("History");
    $("tabExport").onclick = ()=> setView("Export");

    $("homeLogNow").onclick = ()=> (DRAFT ? (applyForm(DRAFT), showModal()) : startNewDraftAndOpen());

    $("resumeDraftBtn").onclick = ()=> { applyForm(DRAFT); showModal(); };
    $("discardDraftBtn").onclick = discardDraft;

    $("closeSheet").onclick = hideModal;
    $("closeSheetFooter").onclick = hideModal;
    $("discardDraftBtnHeader").onclick = discardDraft;
    $("discardDraftBtnFooter").onclick = discardDraft;

    $("saveSheet").onclick = saveLog;
    $("saveSheetInline").onclick = saveLog;

    $("ongoing").onchange = ()=>{
      const ended = $("ongoing").value === "false";
      $("endAtWrap").style.display = ended ? "block" : "none";
      onFormChange();
    };

    $("severity").oninput = ()=> { $("severityVal").textContent = $("severity").value; onFormChange(); };
    $("startAt").onchange = onFormChange;
    $("endAt").onchange = onFormChange;
    $("notes").oninput = ()=> { $("notesCount").textContent = String(($("notes").value||"").length); onFormChange(); };

    $("painTypeOtherText").oninput = ()=>{
      $("painTypeOtherCount").textContent = String(($("painTypeOtherText").value||"").length);
      onFormChange();
    };

    ["v_hr","v_spo2","v_bpsys","v_bpdia"].forEach(id=>{
      $(id).oninput = onFormChange;
    });

    $("historyRange").onchange = renderHistory;
    $("historySeverity").onchange = renderHistory;

    $("exportRange").onchange = renderReport;
    $("refreshReportBtn").onclick = renderReport;
    $("printBtn").onclick = ()=> window.print();
    $("downloadCsvBtn").onclick = ()=>{
      const rows = computeReportRows($("exportRange").value);
      downloadCSV(rows, "chest_pain_report.csv");
    };

    $("createShareBtn").onclick = createOrReplaceShareLink;
    $("copyShareBtn").onclick = copyShareLink;
    $("revokeShareBtn").onclick = revokeShareLink;

    $("exportAllJsonBtn").onclick = ()=>{
      const all = EPISODES.slice().sort((a,b)=> (a.startAt||"").localeCompare(b.startAt||""));
      downloadJSON({ generatedAt: new Date().toISOString(), episodes: all }, "all_chest_pain_data.json");
    };
    $("exportAllCsvBtn").onclick = ()=>{
      const rows = computeReportRows("all");
      downloadCSV(rows, "all_chest_pain_data.csv");
    };
    $("clearAllBtn").onclick = clearAllData;

    $("sharePrintBtn").onclick = ()=> window.print();
  }

  async function init(){
    setSync("Starting…");

    const isShare = await enterShareModeIfHash();
    if(isShare) return;

    try{
      await signInAnonymously(auth);
    }catch(e){
      console.error("Anonymous sign-in failed:", e);
      setSync("Sync error (saved locally)");
    }

    onAuthStateChanged(auth, async (user)=>{
      UID = user?.uid || null;

      await loadMeta();
      await loadLocalEpisodes();

      if(!DRAFT) DRAFT = buildDefaultDraft();
      initChips();
      applyForm(DRAFT);

      renderAll();
      updateShareUI();
      setView("Home");

      if(UID) startMetadataSyncListener();

      if(UID && navigator.onLine){
        setSync("Syncing…");
        for(const ep of EPISODES){
          await upsertEpisodeRemote(ep);
        }
        setSync(lastWriteError ? "Sync error (saved locally)" : "Synced");
      } else {
        setSync("Offline (saved locally)");
      }
    });

    window.addEventListener("online", ()=> setSync(UID ? "Synced" : "Starting…"));
    window.addEventListener("offline", ()=> setSync("Offline (saved locally)"));
  }

  // This keeps your “edit mirrors to episode” behavior (as before)
  const _onFormChange = onFormChange;
  onFormChange = async function(){
    await _onFormChange();
    // no extra work needed here; mirrorDraftToEpisode is called in debounced save when EDITING_ID exists
  };

  wireEvents();
  init();
</script>
</body>
</html>