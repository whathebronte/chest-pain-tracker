<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chest Pain Tracker</title>

  <style>
    :root{
      --bg0:#060a0f;
      --bg1:#0a111b;
      --card:#0c1320cc;
      --card2:#0b1220b8;
      --stroke:#1a2a3a;
      --stroke2:#24384c;
      --text:#e9f0ff;
      --muted:#9fb0c8;
      --muted2:#8396b3;
      --accent:#7aa2ff;
      --good:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;

      /* Elder-friendly scale (subtle, not huge) */
      --fs-base: 17px;   /* was smaller before */
      --fs-sm: 14px;
      --fs-lg: 20px;
      --fs-xl: 26px;

      --radius: 18px;
      --radius-sm: 14px;

      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 8px 22px rgba(0,0,0,.28);

      --tap: 46px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      font-size: var(--fs-base);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 18% 10%, rgba(122,162,255,.25), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(45,212,191,.18), transparent 50%),
        radial-gradient(900px 600px at 70% 90%, rgba(251,113,133,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: env(safe-area-inset-top) 12px calc(90px + env(safe-area-inset-bottom)) 12px;
    }

    .wrap{ max-width: 860px; margin: 0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 10px 0 12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    .logo{
      width:54px; height:54px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(45,212,191,.85));
      box-shadow: var(--shadow2);
      flex: 0 0 auto;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .title h1{
      margin:0;
      font-size: var(--fs-lg);
      line-height:1.2;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .title .sub{
      color: var(--muted);
      font-size: var(--fs-sm);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sync{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(8,12,20,.55);
      box-shadow: var(--shadow2);
      flex: 0 0 auto;
      font-size: var(--fs-sm);
      color: var(--text);
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(251,191,36,.15);
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 4px rgba(45,212,191,.15); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 4px rgba(251,113,133,.12); }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card + .card{ margin-top: 12px; }

    .sectionTitle{
      margin: 0 0 10px;
      font-size: var(--fs-lg);
      letter-spacing:.2px;
    }

    .primaryBtn{
      width:100%;
      min-height: 58px;
      border:0;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(122,162,255,.95), rgba(122,162,255,.72));
      color: #0b1220;
      font-weight: 800;
      font-size: 18px;
      box-shadow: 0 12px 30px rgba(122,162,255,.18);
      cursor:pointer;
      touch-action: manipulation;
    }
    .primaryBtn:active{ transform: translateY(1px); }

    .btn{
      min-height: var(--tap);
      padding: 10px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,16,26,.55);
      color: var(--text);
      font-weight: 700;
      cursor:pointer;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.small{ min-height: 38px; padding: 8px 12px; border-radius: 14px; font-size: 14px; }
    .btn.ghost{ background: transparent; }
    .btn.danger{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.08); color: #ffd2db; }
    .btn.ok{ border-color: rgba(45,212,191,.25); background: rgba(45,212,191,.08); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.nowrap{ flex-wrap:nowrap; }
    .row.spread{ justify-content:space-between; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .glanceGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 680px){
      .glanceGrid{ grid-template-columns: 1fr; }
    }
    .metric{
      background: rgba(6,10,16,.45);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 14px;
    }
    .metric .big{
      font-size: var(--fs-xl);
      font-weight: 900;
      letter-spacing:.2px;
      margin-bottom: 2px;
    }
    .metric .label{
      color: var(--muted);
      font-size: var(--fs-sm);
      font-weight: 650;
    }

    /* Form sections: more separation for elder readability */
    .formSection{
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .formSection:first-child{ margin-top: 0; padding-top: 0; border-top: 0; }
    .formLabel{
      display:flex; align-items:baseline; justify-content:space-between;
      gap: 10px;
      margin: 0 0 10px;
      color: var(--text);
      font-weight: 850;
      letter-spacing:.2px;
    }
    .hint{
      color: var(--muted);
      font-size: var(--fs-sm);
      font-weight: 600;
    }

    .chips{ display:flex; flex-wrap:wrap; gap:10px; }
    .chip{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,16,26,.55);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 750;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .chip[aria-pressed="true"]{
      border-color: rgba(45,212,191,.45);
      box-shadow: 0 0 0 3px rgba(45,212,191,.10) inset;
    }

    input[type="text"], input[type="number"], textarea, select, input[type="datetime-local"]{
      width:100%;
      min-height: var(--tap);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,16,26,.45);
      color: var(--text);
      padding: 10px 12px;
      font-size: 16px;
      outline: none;
    }
    textarea{ min-height: 88px; resize: vertical; }

    /* Thicker slider for elder-friendly */
    input[type="range"]{
      width:100%;
      height: 34px;
      -webkit-appearance: none;
      background: transparent;
      margin: 6px 0 0;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 10px;
      background: rgba(122,162,255,.35);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      width: 28px; height: 28px;
      border-radius: 50%;
      background: linear-gradient(180deg, rgba(122,162,255,.98), rgba(122,162,255,.72));
      border: 1px solid rgba(255,255,255,.25);
      margin-top: -10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    .pillBar{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(14px + env(safe-area-inset-bottom));
      max-width: 860px;
      margin: 0 auto;
      background: rgba(6,10,16,.72);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 10px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      z-index: 40;
    }
    .navBtn{
      flex:1;
      min-height: 48px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,16,26,.45);
      color: var(--text);
      font-weight: 850;
      cursor:pointer;
      touch-action: manipulation;
      font-size: 15px;
    }
    .navBtn.active{
      background: rgba(122,162,255,.25);
      border-color: rgba(122,162,255,.40);
    }

    .page{ display:none; }
    .page.active{ display:block; }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(6,10,16,.40);
      padding: 14px;
      cursor:pointer;
      touch-action: manipulation;
    }
    .item .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .item .when{
      font-weight: 900;
      font-size: 18px;
      line-height: 1.15;
    }
    /* Keep "PM" from wrapping awkwardly: make date+time a unit */
    .nowrapTime{ white-space: nowrap; }
    .item .meta{
      margin-top: 4px;
      color: var(--muted);
      font-weight: 650;
      font-size: 14px;
    }
    .badge{
      font-weight: 900;
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,16,26,.45);
      font-size: 14px;
      white-space: nowrap;
    }

    .stickyActions{
      position: sticky;
      bottom: 0;
      padding-top: 12px;
      margin-top: 12px;
      background: linear-gradient(180deg, transparent, rgba(6,10,16,.85) 30%, rgba(6,10,16,.95));
      border-top: 1px solid rgba(255,255,255,.06);
      z-index: 15;
    }
    .stickyRow{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .stickyRow .btn{ flex: 1; }
    .stickyRow .primaryBtn{ flex: 1.4; min-height: var(--tap); font-size: 16px; border-radius: 16px; }

    .modalBack{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 60;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(720px, 100%);
      background: rgba(9,14,22,.92);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(12px);
      max-height: 82vh;
      overflow:auto;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .modalTitle{
      font-size: 18px;
      font-weight: 900;
      margin:0;
    }

    .muted{ color: var(--muted); }
    .tiny{ font-size: 12px; color: var(--muted2); }

    /* Make the Unique Link buttons smaller and keep one line */
    .linkActions{
      display:flex;
      gap:10px;
      flex-wrap:nowrap;
      align-items:center;
    }
    .linkActions .btn{
      flex: 1;
      min-height: 40px;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 14px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Chest Pain Tracker</h1>
          <div class="sub">Log episodes · Share reports</div>
        </div>
      </div>

      <div class="sync" id="syncPill" title="Sync status">
        <span class="dot" id="syncDot"></span>
        <span id="syncText">Starting…</span>
      </div>
    </div>

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="card">
        <h2 class="sectionTitle">Home</h2>
        <button class="primaryBtn" id="goLogBig">Log Chest Pain</button>
      </div>

      <div class="card">
        <h2 class="sectionTitle">At a glance</h2>
        <div class="glanceGrid">
          <div class="metric">
            <div class="big" id="m7">—</div>
            <div class="label">Episodes (last 7 days)</div>
          </div>
          <div class="metric">
            <div class="big" id="m30">—</div>
            <div class="label">Episodes (last 30 days)</div>
          </div>
          <div class="metric">
            <div class="big" id="mLastSev">—</div>
            <div class="label">Last severity</div>
          </div>
          <div class="metric">
            <div class="big" id="mCommonAct">—</div>
            <div class="label">Most common onset activity (30 days)</div>
          </div>
        </div>
      </div>

      <div class="card" id="draftCard" style="display:none;">
        <h2 class="sectionTitle">Resume draft</h2>
        <div class="muted" id="draftSummary">—</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn ok" id="resumeDraftBtn">Resume</button>
          <button class="btn danger" id="discardDraftBtn">Discard</button>
        </div>
      </div>

      <!-- Unique link at bottom, less cluttered -->
      <div class="card">
        <div class="row spread" style="margin-bottom:8px;">
          <div>
            <div style="font-weight:900;">Your unique link</div>
            <div class="tiny">ID: <span id="shortUid">—</span></div>
          </div>
        </div>

        <div class="linkActions">
          <button class="btn small ok" id="copyLinkBtn">Copy link</button>
          <button class="btn small" id="loadExistingBtn">Load existing</button>
          <button class="btn small ghost" id="showLinkBtn">Show link</button>
        </div>

        <div id="fullLinkWrap" style="display:none; margin-top:10px;">
          <input type="text" id="fullLink" readonly />
        </div>
      </div>
    </div>

    <!-- LOG -->
    <div class="page" id="page-log">
      <div class="card">
        <div class="row spread">
          <h2 class="sectionTitle" style="margin:0;">Log an episode</h2>
          <div class="row" style="gap:10px;">
            <button class="btn" id="closeLogTop">Close</button>
            <button class="btn danger" id="discardLogTop">Discard</button>
          </div>
        </div>

        <div class="formSection">
          <div class="formLabel">
            <span>When did it start?</span>
          </div>
          <input type="datetime-local" id="startAt" />
          <div class="hint" style="margin-top:6px;">If unsure, use “now”.</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn small ok" id="setNowBtn">Set to now</button>
          </div>
        </div>

        <div class="formSection">
          <div class="formLabel">
            <span>Severity</span>
            <span class="hint"><span id="sevNum">5</span>/10</span>
          </div>
          <input type="range" min="0" max="10" step="1" id="severity" />
        </div>

        <div class="formSection">
          <div class="formLabel">
            <span>Duration</span>
          </div>
          <div class="chips" id="durationChips"></div>
        </div>

        <div class="formSection">
          <div class="formLabel">
            <span>Pain type</span>
          </div>
          <div class="chips" id="typeChips"></div>

          <!-- Smaller helper text relative to title -->
          <div style="margin-top:10px;">
            <div style="font-weight:900; font-size: 15px; margin-bottom:6px;">Pain type guide</div>
            <div class="hint" id="typeGuide" style="font-size: 13px; line-height: 1.35;">
              Tap a pain type to see guidance here.
            </div>
          </div>
        </div>

        <div class="formSection">
          <div class="formLabel"><span>Location</span></div>
          <div class="chips" id="locChips"></div>
          <div id="locOtherWrap" style="display:none; margin-top:10px;">
            <input type="text" id="locOther" placeholder="Other location (type here)" />
          </div>
        </div>

        <div class="formSection">
          <div class="formLabel"><span>Activity at onset</span></div>
          <div class="chips" id="actChips"></div>
          <div id="actOtherWrap" style="display:none; margin-top:10px;">
            <input type="text" id="actOther" placeholder="Other activity (type here)" />
          </div>
        </div>

        <div class="formSection">
          <div class="formLabel"><span>Relief</span></div>
          <div class="chips" id="reliefChips"></div>
          <div id="reliefOtherWrap" style="display:none; margin-top:10px;">
            <input type="text" id="reliefOther" placeholder="Other relief (type here)" />
          </div>
        </div>

        <div class="formSection">
          <div class="formLabel"><span>Associated symptoms</span></div>
          <div class="chips" id="symChips"></div>
        </div>

        <div class="formSection">
          <div class="formLabel"><span>Notes</span></div>
          <textarea id="notes" placeholder="Notes"></textarea>
        </div>

        <!-- Save button BEFORE vitals, big, no helper text -->
        <div class="formSection">
          <button class="primaryBtn" id="saveLogBtn">Save log</button>
        </div>

        <div class="formSection">
          <div class="formLabel"><span>Optional vitals</span><span class="hint">(optional)</span></div>
          <div class="grid2">
            <input type="number" id="hr" placeholder="Heart rate (bpm)" />
            <input type="number" id="bpSys" placeholder="BP systolic" />
            <input type="number" id="bpDia" placeholder="BP diastolic" />
            <input type="number" id="spo2" placeholder="SpO₂ (%)" />
          </div>
        </div>

        <div class="stickyActions">
          <div class="stickyRow">
            <button class="btn danger" id="discardLogBottom">Discard</button>
            <button class="btn" id="closeLogBottom">Close</button>
            <button class="primaryBtn" id="saveLogBottom">Save log</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="page" id="page-history">
      <div class="card">
        <div class="row spread">
          <h2 class="sectionTitle" style="margin:0;">History</h2>
        </div>

        <div class="row" style="margin-top:10px;">
          <select id="rangeFilter" style="flex:1;">
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="365">Last 12 months</option>
            <option value="all">All time</option>
          </select>

          <select id="sevFilter" style="flex:1;">
            <option value="all">All severities</option>
            <option value="0-3">0–3</option>
            <option value="4-6">4–6</option>
            <option value="7-10">7–10</option>
          </select>
        </div>

        <div class="hint" style="margin-top:8px;">Most recent first.</div>

        <div style="margin-top:12px;" class="list" id="historyList"></div>
      </div>
    </div>

    <!-- EXPORT -->
    <div class="page" id="page-export">
      <div class="card">
        <div class="row spread" style="align-items:flex-end;">
          <h2 class="sectionTitle" style="margin:0;">Export</h2>
          <div class="row" style="gap:10px;">
            <select id="exportRange" class="btn" style="min-height:40px;">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="365">Last 12 months</option>
              <option value="all">All time</option>
            </select>
            <button class="btn" id="refreshExportBtn">Refresh</button>
          </div>
        </div>

        <div class="card" style="background:rgba(6,10,16,.35); border-radius:18px; border:1px solid rgba(255,255,255,.06); margin-top:14px;">
          <div style="font-weight:900; margin-bottom:10px;">Clinician summary (Print to PDF)</div>
          <div class="row">
            <button class="btn ok" id="printPdfBtn">Print / Save PDF</button>
            <button class="btn" id="downloadCsvBtn">Download CSV</button>
          </div>
        </div>

        <div class="card" style="background:rgba(6,10,16,.35); border-radius:18px; border:1px solid rgba(255,255,255,.06); margin-top:12px;">
          <div style="font-weight:900; margin-bottom:10px;">Share a read-only report link</div>
          <div class="hint" style="margin-bottom:10px;">One active link only. No expiry. Revocable anytime.</div>
          <button class="btn ok" id="createShareBtn" style="width:100%;">Create / Replace share link</button>
          <div id="shareOut" style="display:none; margin-top:10px;">
            <input type="text" id="shareLink" readonly />
            <div class="row" style="margin-top:10px;">
              <button class="btn small ok" id="copyShareBtn">Copy share link</button>
              <button class="btn small danger" id="revokeShareBtn">Revoke</button>
            </div>
          </div>
        </div>

        <!-- Extra spacing so header below doesn't stick to the cards above -->
        <div style="margin-top:16px;">
          <h2 class="sectionTitle" style="margin:0 0 8px;">Chest pain report</h2>
          <div class="hint">Generated: <span id="reportGenerated">—</span></div>
        </div>

        <div class="card" style="background:rgba(6,10,16,.35); border-radius:18px; border:1px solid rgba(255,255,255,.06); margin-top:12px;">
          <div style="font-weight:900; margin-bottom:8px;">Summary</div>
          <div class="muted" id="reportSummary">—</div>
        </div>

        <div class="card" style="background:rgba(6,10,16,.35); border-radius:18px; border:1px solid rgba(255,255,255,.06); margin-top:12px;">
          <div style="font-weight:900; margin-bottom:8px;">Episodes</div>
          <div id="reportEpisodes" class="muted">—</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div style="font-weight:900; margin-bottom:8px;">Advanced</div>
          <div class="row">
            <button class="btn" id="clearAllBtn">Clear ALL data (device + Firebase)</button>
          </div>
          <div class="tiny" style="margin-top:8px;">Use only if you intend to start over.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Load existing UID -->
  <div class="modalBack" id="modalLoad">
    <div class="modal">
      <div class="modalHead">
        <h3 class="modalTitle">Load existing link/ID</h3>
        <button class="btn small" id="closeLoadModal">Close</button>
      </div>
      <div class="hint" style="margin-bottom:10px;">Paste the saved link or paste the ID.</div>
      <input type="text" id="loadInput" placeholder="Paste link or ID..." />
      <div class="row" style="margin-top:12px;">
        <button class="btn ok" id="loadGoBtn" style="flex:1;">Load</button>
      </div>
      <div class="tiny" style="margin-top:10px;">Loading replaces the current view and shows the logs for that ID.</div>
    </div>
  </div>

  <!-- MODAL: Edit/Delete episode -->
  <div class="modalBack" id="modalEdit">
    <div class="modal">
      <div class="modalHead">
        <h3 class="modalTitle">Edit episode</h3>
        <button class="btn small" id="closeEditModal">Close</button>
      </div>

      <div class="hint" id="editMeta" style="margin-bottom:10px;">—</div>

      <div class="formSection">
        <div class="formLabel"><span>Severity</span><span class="hint"><span id="editSevNum">—</span>/10</span></div>
        <input type="range" min="0" max="10" step="1" id="editSeverity" />
      </div>

      <div class="formSection">
        <div class="formLabel"><span>Notes</span></div>
        <textarea id="editNotes"></textarea>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn ok" id="saveEditBtn" style="flex:1;">Save changes</button>
        <button class="btn danger" id="deleteEpisodeBtn" style="flex:1;">Delete</button>
      </div>

      <div class="tiny" style="margin-top:10px;">Tip: if you need full field editing, tell me and I’ll expand this modal.</div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div class="pillBar">
    <button class="navBtn active" data-nav="home">Home</button>
    <button class="navBtn" data-nav="log">Log</button>
    <button class="navBtn" data-nav="history">History</button>
    <button class="navBtn" data-nav="export">Export</button>
  </div>

  <script type="module">
    // ---------------------------
    // 1) PASTE YOUR FIREBASE CONFIG HERE
    // ---------------------------
    // You can copy from Firebase Console -> Project settings -> Your apps -> Config.
    const firebaseConfig = {
      // apiKey: "…",
      // authDomain: "…",
      // projectId: "…",
      // storageBucket: "…",
      // messagingSenderId: "…",
      // appId: "…"
    };

    // ---------------------------
    // Firebase imports (CDN)
    // ---------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, collection,
      setDoc, getDoc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, limit,
      serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ---------------------------
    // Small helpers
    // ---------------------------
    const $ = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const nowLocalInputValue = () => {
      const d = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    };
    const fmtDateTime = (ms) => {
      const d = new Date(ms);
      // Keep AM/PM on same unit as time by using a short format and wrapping with nowrap
      const opts = { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' };
      return d.toLocaleString(undefined, opts);
    };
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const safeJson = (v) => JSON.parse(JSON.stringify(v));

    // ---------------------------
    // 2) UID logic (prevents “data disappeared”)
    // ---------------------------
    function randomUid(){
      // stable-ish, human copyable shortened display, but full is strong random
      const bytes = new Uint8Array(20);
      crypto.getRandomValues(bytes);
      return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function getUidFromUrl(){
      const u = new URL(location.href);
      const uid = u.searchParams.get('uid');
      return uid && uid.trim() ? uid.trim() : null;
    }

    function setUidInUrl(uid){
      const u = new URL(location.href);
      u.searchParams.set('uid', uid);
      history.replaceState({}, "", u.toString());
    }

    function shortUid(uid){ return uid ? uid.slice(0,7) : "—"; }

    // ---------------------------
    // 3) App state + sync indicator
    // ---------------------------
    let app, db;
    let UID = null;
    let viewingUid = null; // same as UID for normal mode
    let episodes = [];     // cached
    let draft = null;
    let isBooted = false;
    let isSaving = false;
    let lastError = null;

    function setSync(state, msg){
      const dot = $("syncDot");
      const txt = $("syncText");
      dot.classList.remove("good","bad");
      if(state === "good"){ dot.classList.add("good"); txt.textContent = msg || "Synced"; }
      else if(state === "bad"){ dot.classList.add("bad"); txt.textContent = msg || "Error"; }
      else { txt.textContent = msg || "Starting…"; }
    }

    function markSaving(on){
      isSaving = on;
      if(lastError){
        setSync("bad", "Error");
        return;
      }
      if(!isBooted){
        setSync(null, "Starting…");
        return;
      }
      if(on) setSync(null, "Saving…");
      else setSync("good", "Synced");
    }

    function setError(err){
      lastError = err;
      console.error(err);
      setSync("bad", "Error");
      alert(err?.message ? err.message : String(err));
    }

    // ---------------------------
    // 4) Data paths
    // ---------------------------
    function userRoot(uid){ return doc(db, "users", uid); }
    function draftDoc(uid){ return doc(db, "users", uid, "drafts", "current"); }
    function episodeCol(uid){ return collection(db, "users", uid, "episodes"); }
    function episodeDoc(uid, id){ return doc(db, "users", uid, "episodes", id); }

    // Share link docs (this assumes you already have rules supporting it)
    function shareDoc(uid){ return doc(db, "users", uid, "share", "active"); }

    // ---------------------------
    // 5) UI navigation
    // ---------------------------
    const pages = {
      home: $("page-home"),
      log: $("page-log"),
      history: $("page-history"),
      export: $("page-export"),
    };

    function showPage(key){
      Object.entries(pages).forEach(([k, el]) => el.classList.toggle("active", k === key));
      document.querySelectorAll(".navBtn").forEach(b => b.classList.toggle("active", b.dataset.nav === key));
      if(key === "export") renderReport();
      if(key === "history") renderHistory();
    }

    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>showPage(btn.dataset.nav));
    });

    $("goLogBig").addEventListener("click", ()=>showPage("log"));

    // ---------------------------
    // 6) Chips data
    // ---------------------------
    const DURATIONS = ["Seconds/minutes", "10–30 minutes", "30–60 minutes", "1–3 hours", "More than 3 hours", "Ongoing"];
    const TYPES = [
      { key:"Pressure", help:"Pressure/tightness/heaviness. Often described as squeezing." },
      { key:"Sharp", help:"Sharp or stabbing pain. Can be worse with breathing or movement." },
      { key:"Burning", help:"Burning sensation. Sometimes related to reflux/heartburn." },
      { key:"Aching", help:"Dull ache or soreness." },
      { key:"Other", help:"If it doesn’t fit the above, choose Other and add a note." }
    ];
    const LOCS = ["Center","Left","Right","Upper abdomen","Other"];
    const ACTS = ["Rest","Walking","Stairs","Exercise","After meal","Stress","Sleeping","Other"];
    const RELIEFS = ["Rest","Breathing","Antacid","Nitro","Painkiller","None","Other"];
    const SYMS = ["Shortness of breath","Sweating","Nausea","Dizziness","Palpitations","Radiation (arm/jaw/back)","None"];

    function makeChip(container, label, groupKey, multi=false){
      const b = document.createElement("button");
      b.className = "chip";
      b.type = "button";
      b.textContent = label;
      b.setAttribute("aria-pressed","false");
      b.addEventListener("click", ()=>{
        if(multi){
          const on = b.getAttribute("aria-pressed")==="true";
          b.setAttribute("aria-pressed", on ? "false" : "true");
        }else{
          [...container.querySelectorAll(".chip")].forEach(x=>x.setAttribute("aria-pressed","false"));
          b.setAttribute("aria-pressed","true");
        }
        onAnyDraftChange();
        if(groupKey==="type"){
          const t = TYPES.find(x=>x.key===label);
          $("typeGuide").textContent = t ? t.help : "Tap a pain type to see guidance here.";
        }
        if(groupKey==="loc") $("locOtherWrap").style.display = (label==="Other" && b.getAttribute("aria-pressed")==="true") ? "block" : "none";
        if(groupKey==="act") $("actOtherWrap").style.display = (label==="Other" && b.getAttribute("aria-pressed")==="true") ? "block" : "none";
        if(groupKey==="relief") $("reliefOtherWrap").style.display = (label==="Other" && b.getAttribute("aria-pressed")==="true") ? "block" : "none";
      });
      container.appendChild(b);
    }

    function initChips(){
      const dur = $("durationChips");
      DURATIONS.forEach(x=>makeChip(dur,x,"duration",false));

      const typ = $("typeChips");
      TYPES.forEach(x=>makeChip(typ,x.key,"type",false));

      const loc = $("locChips");
      LOCS.forEach(x=>makeChip(loc,x,"loc",false));

      const act = $("actChips");
      ACTS.forEach(x=>makeChip(act,x,"act",false));

      const rel = $("reliefChips");
      RELIEFS.forEach(x=>makeChip(rel,x,"relief",false));

      const sym = $("symChips");
      SYMS.forEach(x=>makeChip(sym,x,"sym",true));
    }

    function getSingleChipValue(container){
      const on = container.querySelector('.chip[aria-pressed="true"]');
      return on ? on.textContent : null;
    }
    function getMultiChipValues(container){
      return [...container.querySelectorAll('.chip[aria-pressed="true"]')].map(x=>x.textContent);
    }
    function setSingleChipValue(container, value){
      [...container.querySelectorAll(".chip")].forEach(x=>{
        x.setAttribute("aria-pressed", x.textContent===value ? "true" : "false");
      });
    }
    function setMultiChipValues(container, values){
      const set = new Set(values || []);
      [...container.querySelectorAll(".chip")].forEach(x=>{
        x.setAttribute("aria-pressed", set.has(x.textContent) ? "true" : "false");
      });
    }

    // ---------------------------
    // 7) Draft autosave (and the “buttons not working” issue)
    // ---------------------------
    let draftSaveTimer = null;

    function collectDraftFromUI(){
      const loc = getSingleChipValue($("locChips"));
      const act = getSingleChipValue($("actChips"));
      const relief = getSingleChipValue($("reliefChips"));
      return {
        startAt: $("startAt").value || null,
        severity: Number($("severity").value ?? 5),
        duration: getSingleChipValue($("durationChips")),
        type: getSingleChipValue($("typeChips")),
        location: loc,
        locationOther: loc==="Other" ? ($("locOther").value || "") : "",
        activity: act,
        activityOther: act==="Other" ? ($("actOther").value || "") : "",
        relief: relief,
        reliefOther: relief==="Other" ? ($("reliefOther").value || "") : "",
        symptoms: getMultiChipValues($("symChips")),
        notes: $("notes").value || "",
        vitals: {
          hr: $("hr").value ? Number($("hr").value) : null,
          bpSys: $("bpSys").value ? Number($("bpSys").value) : null,
          bpDia: $("bpDia").value ? Number($("bpDia").value) : null,
          spo2: $("spo2").value ? Number($("spo2").value) : null,
        },
        updatedAt: Date.now()
      };
    }

    function applyDraftToUI(d){
      if(!d) return;
      $("startAt").value = d.startAt || "";
      $("severity").value = clamp(Number(d.severity ?? 5),0,10);
      $("sevNum").textContent = String($("severity").value);

      setSingleChipValue($("durationChips"), d.duration || null);
      setSingleChipValue($("typeChips"), d.type || null);
      setSingleChipValue($("locChips"), d.location || null);
      setSingleChipValue($("actChips"), d.activity || null);
      setSingleChipValue($("reliefChips"), d.relief || null);
      setMultiChipValues($("symChips"), d.symptoms || []);

      $("locOther").value = d.locationOther || "";
      $("actOther").value = d.activityOther || "";
      $("reliefOther").value = d.reliefOther || "";

      $("locOtherWrap").style.display = (d.location==="Other") ? "block" : "none";
      $("actOtherWrap").style.display = (d.activity==="Other") ? "block" : "none";
      $("reliefOtherWrap").style.display = (d.relief==="Other") ? "block" : "none";

      $("notes").value = d.notes || "";

      $("hr").value = d.vitals?.hr ?? "";
      $("bpSys").value = d.vitals?.bpSys ?? "";
      $("bpDia").value = d.vitals?.bpDia ?? "";
      $("spo2").value = d.vitals?.spo2 ?? "";

      if(d.type){
        const t = TYPES.find(x=>x.key===d.type);
        $("typeGuide").textContent = t ? t.help : "Tap a pain type to see guidance here.";
      }
    }

    async function saveDraftDebounced(){
      if(!isBooted) return;
      if(draftSaveTimer) clearTimeout(draftSaveTimer);
      draftSaveTimer = setTimeout(async ()=>{
        try{
          markSaving(true);
          const d = collectDraftFromUI();
          await setDoc(draftDoc(UID), {
            ...safeJson(d),
            updatedAt: serverTimestamp()
          }, { merge:true });
          markSaving(false);
        }catch(e){
          setError(e);
        }
      }, 400);
    }

    function onAnyDraftChange(){
      // Called after any UI change
      saveDraftDebounced();
    }

    function wireDraftInputs(){
      ["startAt","notes","locOther","actOther","reliefOther","hr","bpSys","bpDia","spo2"].forEach(id=>{
        $(id).addEventListener("input", onAnyDraftChange);
      });
      $("severity").addEventListener("input", ()=>{
        $("sevNum").textContent = $("severity").value;
        onAnyDraftChange();
      });
    }

    // ---------------------------
    // 8) Save log / Close / Discard (fix “buttons not working”)
    // ---------------------------
    function clearLogUI(){
      $("startAt").value = nowLocalInputValue();
      $("severity").value = 5;
      $("sevNum").textContent = "5";
      ["durationChips","typeChips","locChips","actChips","reliefChips"].forEach(id=>{
        [...$(id).querySelectorAll(".chip")].forEach(x=>x.setAttribute("aria-pressed","false"));
      });
      [...$("symChips").querySelectorAll(".chip")].forEach(x=>x.setAttribute("aria-pressed","false"));

      $("locOther").value="";
      $("actOther").value="";
      $("reliefOther").value="";
      $("locOtherWrap").style.display="none";
      $("actOtherWrap").style.display="none";
      $("reliefOtherWrap").style.display="none";
      $("typeGuide").textContent = "Tap a pain type to see guidance here.";
      $("notes").value="";
      ["hr","bpSys","bpDia","spo2"].forEach(id=>$(id).value="");
    }

    function validateEpisode(d){
      // keep it simple: we’ll allow partial, but we want at least severity + start time
      if(!d.startAt) return "Please set the start time.";
      if(d.severity === null || Number.isNaN(d.severity)) return "Please set a severity.";
      return null;
    }

    async function saveLog(){
      try{
        if(!isBooted) throw new Error("App is still starting. Try again in a moment.");
        const d = collectDraftFromUI();
        const err = validateEpisode(d);
        if(err){ alert(err); return; }

        markSaving(true);

        const startMs = new Date(d.startAt).getTime();
        const id = String(startMs) + "_" + crypto.randomUUID().slice(0,8);

        await setDoc(episodeDoc(UID, id), {
          ...safeJson(d),
          startMs,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        // Clear draft after save
        await deleteDoc(draftDoc(UID));

        markSaving(false);
        clearLogUI();
        showPage("history");
      }catch(e){
        setError(e);
      }
    }

    async function discardDraft(){
      try{
        if(!isBooted) return;
        const ok = confirm("Discard the current draft?");
        if(!ok) return;
        markSaving(true);
        await deleteDoc(draftDoc(UID));
        markSaving(false);
        clearLogUI();
        showPage("home");
      }catch(e){
        setError(e);
      }
    }

    function closeLog(){
      showPage("home");
    }

    // Wire buttons (top + bottom)
    function wireLogButtons(){
      $("saveLogBtn").addEventListener("click", saveLog);
      $("saveLogBottom").addEventListener("click", saveLog);

      $("discardLogTop").addEventListener("click", discardDraft);
      $("discardLogBottom").addEventListener("click", discardDraft);

      $("closeLogTop").addEventListener("click", closeLog);
      $("closeLogBottom").addEventListener("click", closeLog);

      $("setNowBtn").addEventListener("click", ()=>{
        $("startAt").value = nowLocalInputValue();
        onAnyDraftChange();
      });
    }

    // ---------------------------
    // 9) Home: unique link actions
    // ---------------------------
    function currentLink(){
      return new URL(location.href).toString();
    }

    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        alert("Copied!");
      }catch{
        // fallback
        const t = document.createElement("textarea");
        t.value = txt;
        document.body.appendChild(t);
        t.select();
        document.execCommand("copy");
        t.remove();
        alert("Copied!");
      }
    }

    $("copyLinkBtn").addEventListener("click", ()=>copyText(currentLink()));
    $("showLinkBtn").addEventListener("click", ()=>{
      $("fullLink").value = currentLink();
      $("fullLinkWrap").style.display = $("fullLinkWrap").style.display === "none" ? "block" : "none";
    });

    // Load modal
    const modalLoad = $("modalLoad");
    $("loadExistingBtn").addEventListener("click", ()=>{
      $("loadInput").value = "";
      modalLoad.classList.add("show");
      $("loadInput").focus();
    });
    $("closeLoadModal").addEventListener("click", ()=>modalLoad.classList.remove("show"));
    modalLoad.addEventListener("click", (e)=>{ if(e.target===modalLoad) modalLoad.classList.remove("show"); });

    $("loadGoBtn").addEventListener("click", ()=>{
      const raw = $("loadInput").value.trim();
      if(!raw){ alert("Paste a link or ID."); return; }
      let uid = raw;
      try{
        if(raw.includes("http")){
          const u = new URL(raw);
          uid = u.searchParams.get("uid") || raw;
        }
      }catch{}
      uid = uid.trim();
      if(uid.length < 6){ alert("That ID looks too short."); return; }
      // Navigate to same page with uid
      const u = new URL(location.href);
      u.searchParams.set("uid", uid);
      location.href = u.toString();
    });

    // ---------------------------
    // 10) Draft card (home)
    // ---------------------------
    $("resumeDraftBtn").addEventListener("click", ()=>{
      showPage("log");
    });
    $("discardDraftBtn").addEventListener("click", discardDraft);

    // ---------------------------
    // 11) History rendering + click to edit/delete
    // ---------------------------
    const modalEdit = $("modalEdit");
    let editingEpisodeId = null;

    function openEdit(ep){
      editingEpisodeId = ep.id;
      $("editMeta").textContent = fmtDateTime(ep.startMs);
      $("editSeverity").value = clamp(Number(ep.severity ?? 0),0,10);
      $("editSevNum").textContent = String($("editSeverity").value);
      $("editNotes").value = ep.notes || "";
      modalEdit.classList.add("show");
    }

    $("closeEditModal").addEventListener("click", ()=>modalEdit.classList.remove("show"));
    modalEdit.addEventListener("click", (e)=>{ if(e.target===modalEdit) modalEdit.classList.remove("show"); });
    $("editSeverity").addEventListener("input", ()=>{
      $("editSevNum").textContent = $("editSeverity").value;
    });

    $("saveEditBtn").addEventListener("click", async ()=>{
      try{
        if(!editingEpisodeId) return;
        markSaving(true);
        await updateDoc(episodeDoc(UID, editingEpisodeId), {
          severity: Number($("editSeverity").value),
          notes: $("editNotes").value || "",
          updatedAt: serverTimestamp()
        });
        markSaving(false);
        modalEdit.classList.remove("show");
      }catch(e){ setError(e); }
    });

    $("deleteEpisodeBtn").addEventListener("click", async ()=>{
      try{
        if(!editingEpisodeId) return;
        const ok = confirm("Delete this episode?");
        if(!ok) return;
        markSaving(true);
        await deleteDoc(episodeDoc(UID, editingEpisodeId));
        markSaving(false);
        modalEdit.classList.remove("show");
      }catch(e){ setError(e); }
    });

    function filteredEpisodes(){
      const range = $("rangeFilter").value;
      const sev = $("sevFilter").value;

      let minMs = -Infinity;
      if(range !== "all"){
        const days = Number(range);
        minMs = Date.now() - days*24*60*60*1000;
      }

      let [smin,smax] = [0,10];
      if(sev === "0-3") [smin,smax] = [0,3];
      if(sev === "4-6") [smin,smax] = [4,6];
      if(sev === "7-10") [smin,smax] = [7,10];

      return episodes
        .filter(e => e.startMs >= minMs)
        .filter(e => {
          if(sev === "all") return true;
          const v = Number(e.severity ?? 0);
          return v >= smin && v <= smax;
        })
        .sort((a,b)=>b.startMs - a.startMs);
    }

    function renderHistory(){
      const list = $("historyList");
      list.innerHTML = "";
      const arr = filteredEpisodes();
      if(arr.length === 0){
        list.innerHTML = `<div class="muted">No episodes in this range.</div>`;
        return;
      }

      for(const ep of arr){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="top">
            <div>
              <div class="when">
                <span class="nowrapTime">${fmtDateTime(ep.startMs)}</span>
              </div>
              <div class="meta">
                ${(ep.type||"—")} · ${(ep.location||"—")} · ${(ep.activity||"—")}
              </div>
            </div>
            <div class="badge">${Number(ep.severity ?? 0)}/10</div>
          </div>
        `;
        div.addEventListener("click", ()=>openEdit(ep));
        list.appendChild(div);
      }
    }

    $("rangeFilter").addEventListener("change", renderHistory);
    $("sevFilter").addEventListener("change", renderHistory);

    // ---------------------------
    // 12) Home metrics
    // ---------------------------
    function computeMetrics(){
      const now = Date.now();
      const d7 = now - 7*24*60*60*1000;
      const d30 = now - 30*24*60*60*1000;

      const in7 = episodes.filter(e=>e.startMs>=d7);
      const in30 = episodes.filter(e=>e.startMs>=d30);

      $("m7").textContent = String(in7.length);
      $("m30").textContent = String(in30.length);

      const last = episodes.slice().sort((a,b)=>b.startMs-a.startMs)[0];
      $("mLastSev").textContent = last ? `${Number(last.severity ?? 0)}/10` : "—";

      // most common activity last 30 days
      const counts = new Map();
      for(const e of in30){
        const k = e.activity || "—";
        counts.set(k, (counts.get(k)||0)+1);
      }
      let best = "—", bestN = 0;
      for(const [k,n] of counts.entries()){
        if(n>bestN){ best=k; bestN=n; }
      }
      $("mCommonAct").textContent = best;

      // Unique link UI
      $("shortUid").textContent = shortUid(UID);
    }

    // ---------------------------
    // 13) Export report + CSV + Print
    // ---------------------------
    function episodesInExportRange(){
      const range = $("exportRange").value;
      let minMs = -Infinity;
      if(range !== "all"){
        const days = Number(range);
        minMs = Date.now() - days*24*60*60*1000;
      }
      return episodes.filter(e=>e.startMs>=minMs).sort((a,b)=>b.startMs-a.startMs);
    }

    function renderReport(){
      $("reportGenerated").textContent = fmtDateTime(Date.now());
      const arr = episodesInExportRange();
      if(arr.length === 0){
        $("reportSummary").textContent = "No episodes in this range.";
        $("reportEpisodes").textContent = "—";
        return;
      }

      const total = arr.length;
      const avg = arr.reduce((s,e)=>s+Number(e.severity||0),0)/total;
      const max = Math.max(...arr.map(e=>Number(e.severity||0)));

      const actCount = new Map();
      for(const e of arr){
        const k = e.activity || "—";
        actCount.set(k, (actCount.get(k)||0)+1);
      }
      let topAct="—", topN=0;
      for(const [k,n] of actCount.entries()){
        if(n>topN){ topAct=k; topN=n; }
      }

      $("reportSummary").textContent =
        `Total episodes: ${total}. Average severity: ${avg.toFixed(1)}/10 (max ${max}/10). Most common onset activity: ${topAct} (${topN}).`;

      $("reportEpisodes").innerHTML = arr.slice(0,50).map(e=>{
        const dt = fmtDateTime(e.startMs);
        const dur = e.duration || "—";
        const type = e.type || "—";
        const loc = e.location || "—";
        const act = e.activity || "—";
        return `<div style="padding:10px 0; border-top:1px solid rgba(255,255,255,.06);">
          <div style="font-weight:900;">${dt}</div>
          <div class="muted">${Number(e.severity||0)}/10 · ${dur} · ${type} · ${loc} · ${act}</div>
        </div>`;
      }).join("");
    }

    $("refreshExportBtn").addEventListener("click", renderReport);
    $("exportRange").addEventListener("change", renderReport);

    function toCsv(rows){
      const esc = (s) => `"${String(s??"").replaceAll('"','""')}"`;
      const headers = [
        "start_time","severity","duration","type","location","location_other",
        "activity","activity_other","relief","relief_other","symptoms","notes",
        "hr","bp_sys","bp_dia","spo2"
      ];
      const lines = [headers.join(",")];
      for(const r of rows){
        lines.push([
          esc(fmtDateTime(r.startMs)),
          esc(r.severity),
          esc(r.duration),
          esc(r.type),
          esc(r.location),
          esc(r.locationOther),
          esc(r.activity),
          esc(r.activityOther),
          esc(r.relief),
          esc(r.reliefOther),
          esc((r.symptoms||[]).join("; ")),
          esc(r.notes),
          esc(r.vitals?.hr),
          esc(r.vitals?.bpSys),
          esc(r.vitals?.bpDia),
          esc(r.vitals?.spo2),
        ].join(","));
      }
      return lines.join("\n");
    }

    $("downloadCsvBtn").addEventListener("click", ()=>{
      const arr = episodesInExportRange();
      const csv = toCsv(arr);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `chest-pain-logs_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $("printPdfBtn").addEventListener("click", ()=>{
      // Print just the report section by temporarily switching pages to export and calling print.
      showPage("export");
      setTimeout(()=>window.print(), 200);
    });

    // ---------------------------
    // 14) Share link (uses your existing rules model)
    // ---------------------------
    async function createOrReplaceShare(){
      try{
        if(!isBooted) throw new Error("App is still starting.");
        markSaving(true);

        const token = crypto.randomUUID().replaceAll("-","");
        const link = new URL(location.href);
        link.searchParams.set("share", token);

        // Save share info under user's doc (one active link model)
        await setDoc(shareDoc(UID), {
          token,
          createdAt: serverTimestamp(),
          url: link.toString()
        }, { merge:true });

        markSaving(false);
        $("shareOut").style.display = "block";
        $("shareLink").value = link.toString();
      }catch(e){
        markSaving(false);
        // This is where you saw "Could not create share link. Check rules."
        // If it happens again, it’s almost always Firestore rules denying write to users/{uid}/share/active
        setError(new Error("Could not create share link. Check rules.\n\n" + (e?.message || e)));
      }
    }

    $("createShareBtn").addEventListener("click", createOrReplaceShare);
    $("copyShareBtn").addEventListener("click", ()=>copyText($("shareLink").value));
    $("revokeShareBtn").addEventListener("click", async ()=>{
      try{
        const ok = confirm("Revoke the share link?");
        if(!ok) return;
        markSaving(true);
        await deleteDoc(shareDoc(UID));
        markSaving(false);
        $("shareOut").style.display = "none";
        $("shareLink").value = "";
      }catch(e){ setError(e); }
    });

    async function loadShareState(){
      try{
        const snap = await getDoc(shareDoc(UID));
        if(snap.exists()){
          const data = snap.data();
          if(data?.url){
            $("shareOut").style.display = "block";
            $("shareLink").value = data.url;
          }
        }else{
          $("shareOut").style.display = "none";
        }
      }catch{
        // don’t hard-fail export UI if rules block share reads
      }
    }

    // ---------------------------
    // 15) Clear all
    // ---------------------------
    $("clearAllBtn").addEventListener("click", async ()=>{
      const ok = confirm("This clears the draft and all episodes for this ID. Continue?");
      if(!ok) return;
      alert("For safety, I didn’t implement bulk delete client-side (it can be slow and risky). Tell me if you want it, and I’ll add a controlled version.");
    });

    // ---------------------------
    // 16) Firestore listeners
    // ---------------------------
    let unsubEpisodes = null;
    let unsubDraft = null;

    function subscribeAll(){
      if(unsubEpisodes) unsubEpisodes();
      if(unsubDraft) unsubDraft();

      // Episodes
      const q = query(episodeCol(UID), orderBy("startMs","desc"), limit(500));
      unsubEpisodes = onSnapshot(q, (snap)=>{
        episodes = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        computeMetrics();
        renderHistory();
        renderReport();
      }, (err)=> setError(err));

      // Draft
      unsubDraft = onSnapshot(draftDoc(UID), (snap)=>{
        if(snap.exists()){
          draft = snap.data();
          $("draftCard").style.display = "block";
          // summary
          const s = draft;
          const sev = (s?.severity ?? "—") + "/10";
          const typ = s?.type || "—";
          const loc = s?.location || "—";
          const act = s?.activity || "—";
          let t = "—";
          if(s?.startAt){
            const ms = new Date(s.startAt).getTime();
            if(!Number.isNaN(ms)) t = fmtDateTime(ms);
          }
          $("draftSummary").textContent = `${t} • ${sev} • ${typ} • ${loc} • ${act}`;
          // keep UI in sync if user refreshed while drafting
          applyDraftToUI(s);
        }else{
          draft = null;
          $("draftCard").style.display = "none";
        }
      }, (err)=> setError(err));
    }

    // ---------------------------
    // 17) Boot / handshake
    // ---------------------------
    function configLooksSet(cfg){
      return cfg && typeof cfg === "object" && !!cfg.apiKey && !!cfg.projectId && !!cfg.appId;
    }

    async function handshake(){
      // Tiny write to confirm rules allow at least a user doc upsert.
      await setDoc(userRoot(UID), { lastSeenAt: serverTimestamp() }, { merge:true });
    }

    async function boot(){
      try{
        setSync(null, "Starting…");

        // UID resolution
        UID = getUidFromUrl();
        if(!UID){
          const saved = localStorage.getItem("cpt_last_uid");
          if(saved) UID = saved;
        }
        if(!UID){
          UID = randomUid();
        }

        localStorage.setItem("cpt_last_uid", UID);
        setUidInUrl(UID);

        $("shortUid").textContent = shortUid(UID);
        $("fullLink").value = currentLink();

        // Firebase init
        if(!configLooksSet(firebaseConfig)){
          throw new Error("Firebase config is missing. Paste your firebaseConfig at the top of the file.");
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);

        // Set default log start time
        $("startAt").value = nowLocalInputValue();
        $("severity").value = 5;
        $("sevNum").textContent = "5";

        // Handshake
        await handshake();

        isBooted = true;
        lastError = null;

        // Subscribe
        subscribeAll();
        await loadShareState();

        markSaving(false);
      }catch(e){
        isBooted = false;
        setError(e);
      }
    }

    // ---------------------------
    // Init
    // ---------------------------
    initChips();
    wireDraftInputs();
    wireLogButtons();

    // Default history filters requested
    $("rangeFilter").value = "7";
    $("sevFilter").value = "all";

    // Kick off
    boot();
  </script>
</body>
</html>
